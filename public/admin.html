<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BeØ¬ÙˆØ±ÙŠ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4338ca">
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- âœ… Ù…ÙƒØªØ¨Ø© Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Cairo'], en: ['Fredoka'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)' },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, 
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        float: { '0%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-10px)' }, '100%': { transform: 'translateY(0px)' } },
                        pulsered: { '0%, 100%': { backgroundColor: 'rgba(239, 68, 68, 1)' }, '50%': { backgroundColor: 'rgba(239, 68, 68, 0.5)' } }
                    } 
                } 
            } 
        }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: 'Cairo', sans-serif; transition: background-color 0.3s; }
        .dark body { background-color: #0f172a; color: #e2e8f0; }
        .app-bg { position: fixed; inset: 0; z-index: -1; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; }
        .locked-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .verse-bubble { background-color: #fff; border-radius: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 2px solid #6366f1; animation: float 5s ease-in-out infinite; }
        .dark .verse-bubble { background-color: #1e293b; border-color: #4f46e5; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); }
        .chat-bubble-user { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; border-radius: 20px 20px 5px 20px; }
        .chat-bubble-ai { background: #ffffff; border-radius: 20px 20px 20px 5px; }
        .dark .chat-bubble-ai { background: #1e293b; color: #e2e8f0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // âœ… Ø¨ÙŠØ§Ù†Ø§Øª Supabase 
        const SUPABASE_URL = "https://ozdnyepxfcjzldpkteau.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFub24iLCJpYXQiOjE3NjQxMDUzNzIsImV4cCI6MjA3OTY4MTM3Mn0.SzRJkjHJJ1mk1CFfOqF6rjyLj3TOD4KhkqzlPfUfS7A";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const GEMINI_API_KEY = "AIzaSyCG7aXcmYLDnVrQCo_hvgMbzYxklG4yJ-Y"; 

        const TRANSLATIONS = {
            ar: {
                appTitle: "BeØ¬ÙˆØ±ÙŠ", subTitle: "Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ÙƒÙ†ÙŠØ³Ø©", loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
                free: "Ù…Ø¬Ø§Ù†ÙŠ ğŸ", locked: "Ø§Ø¶ØºØ· Ù„Ù„ÙØªØ­", open: "Ù…ÙØªÙˆØ­ âœ…",
                loginTitle: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„", scanBtn: "ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§", manualBtn: "Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯", activateBtn: "ØªÙØ¹ÙŠÙ„ ğŸš€",
                errUsed: "Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„! ğŸš«", errWrong: "ÙƒÙˆØ¯ Ù„Ø¹Ø¯Ø¯ Ø¢Ø®Ø±! âš ï¸", errInvalid: "ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦! âŒ",
                chatWelcome: "Ø³Ù„Ø§Ù… ÙˆÙ†Ø¹Ù…Ø© ÙŠØ§ Ø¨Ø·Ù„! â¤ï¸ Ø£Ù†Ø§ Ø¹Ù…Ùˆ ÙÙ‡ÙŠÙ…ØŒ Ø®Ø§Ø¯Ù… ÙÙŠ ÙƒÙ†ÙŠØ³Ø© Ù…Ø§Ø±Ù…ÙŠÙ†Ø§ ÙˆØ§Ù„Ø¨Ø§Ø¨Ø§ ÙƒÙŠØ±Ù„Ø³. Ù…Ø³ØªØ¹Ø¯ Ø£Ø¬Ø§ÙˆØ¨Ùƒ Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø¤Ø§Ù„!", chatPlaceholder: "Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...",
                verseTitle: "Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø¡ ğŸ•Šï¸", langBtn: "English",
                introTitle: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ø¨Ø·Ù„! ğŸ‘‹", introBody: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ BeØ¬ÙˆØ±ÙŠ.", introBtn: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš€",
                quizTab: "ğŸ† Ù…Ø³Ø§Ø¨Ù‚Ø©", quizSetup: "Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©", qCount: "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:", qDiff: "Ø§Ù„ØµØ¹ÙˆØ¨Ø©:", 
                diffEasy: "Ø³Ù‡Ù„ ğŸ¤“", diffMedium: "Ù…ØªÙˆØ³Ø· ğŸ˜", diffHard: "ØµØ¹Ø¨ ğŸ¤¯", startQuiz: "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ ğŸ”¥",
                score: "Ø§Ù„Ù†ØªÙŠØ¬Ø©", playAgain: "Ø§Ù„Ø¹Ø¨ ØªØ§Ù†ÙŠ ğŸ”„",
                qSource: "Ù…ØµØ¯Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:", qSrcInside: "Ù…Ù† Ù‚Ù„Ø¨ Ø§Ù„Ù…Ø¬Ù„Ø© ğŸ“–", qSrcOutside: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© ğŸŒ",
                qType: "Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:", qTypeRel: "Ø¯ÙŠÙ†ÙŠ âœï¸", qTypeSci: "Ø¹Ù„Ù…ÙŠ ğŸ”¬"
            },
            en: {
                appTitle: "BeJouri", subTitle: "Church Heroes", loading: "Loading...",
                free: "Free ğŸ", locked: "Tap to Unlock", open: "Open âœ…",
                loginTitle: "Heroes Gate", scanBtn: "ğŸ“· Scan QR", manualBtn: "Enter Code", activateBtn: "Activate ğŸš€",
                errUsed: "Code Used! ğŸš«", errWrong: "Wrong Issue! âš ï¸", errInvalid: "Invalid Code! âŒ",
                chatWelcome: "Hello Hero! â¤ï¸ I'm Uncle Fahim, from St. Mina & Pope Kyrillos Church.", chatPlaceholder: "Type your question...",
                verseTitle: "Message from Heaven ğŸ•Šï¸", langBtn: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
                introTitle: "Welcome Hero! ğŸ‘‹", introBody: "Welcome to BeJouri app.", introBtn: "Start Journey ğŸš€",
                quizTab: "ğŸ† Quiz", quizSetup: "Quiz Setup", qCount: "Questions:", qDiff: "Difficulty:",
                diffEasy: "Easy ğŸ¤“", diffMedium: "Medium ğŸ˜", diffHard: "Hard ğŸ¤¯", startQuiz: "Start Challenge ğŸ”¥",
                score: "Score", playAgain: "Play Again ğŸ”„",
                qSource: "Source:", qSrcInside: "Inside Magazine ğŸ“–", qSrcOutside: "General Knowledge ğŸŒ",
                qType: "Type:", qTypeRel: "Religious âœï¸", qTypeSci: "Scientific ğŸ”¬"
            }
        };

        function getYoutubeEmbed(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) return `https://www.youtube.com/embed/${match[2]}`;
            return null;
        }

        async function checkCodeOnline(code, issueId) {
            try {
                const cleanCode = code.trim().toUpperCase();
                if(cleanCode === "ADMIN123") return { success: true };
                const { data, error } = await supabase.from('codes').select('*').eq('code', cleanCode).single();
                if (error || !data) return { success: false, error: "INVALID" };
                if (String(data.issue_id) !== String(issueId)) return { success: false, error: "WRONG_ISSUE" };
                if (data.used) return { success: false, error: "USED" };
                await supabase.from('codes').update({ used: true, used_at: new Date() }).eq('code', cleanCode);
                return { success: true };
            } catch (e) { return { success: false, error: "NET_ERROR" }; }
        }

        function IntroModal({ onClose, data, t }) {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-fade-in">
                    <div className="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-sm text-center shadow-2xl border-4 border-indigo-500 relative overflow-hidden animate-pop-in">
                        <div className="text-6xl mb-6 animate-bounce">ğŸ‘‹â¤ï¸</div>
                        <h2 className="text-2xl font-black text-indigo-800 dark:text-white mb-4">{data.title || t.introTitle}</h2>
                        <p className="text-lg text-gray-600 dark:text-gray-300 mb-8 leading-relaxed">{data.body || t.introBody}</p>
                        <button onClick={onClose} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-black text-xl shadow-lg hover:scale-105 transition transform">{t.introBtn}</button>
                    </div>
                </div>
            );
        }
        
        function ChatBot({ t, issueContext }) {
            const ANON_KEY = SUPABASE_KEY;
            const [msgs, setMsgs] = React.useState([{ role: 'model', text: t.chatWelcome }]);
            const [input, setInput] = React.useState("");
            const [loading, setLoading] = React.useState(false);
            const endRef = React.useRef(null);

            React.useEffect(() => { endRef.current?.scrollIntoView({ behavior: "smooth" }); }, [msgs, loading]);

            const sendPayload = async (text) => {
                setLoading(true);
                try {
                    const functionUrl = `${SUPABASE_URL}/functions/v1/chat-with-ai`;
                    const response = await fetch(functionUrl, { 
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${ANON_KEY}`, 
                            'apikey': ANON_KEY 
                        },
                        body: JSON.stringify({ 
                            prompt: text, 
                            context: issueContext || "Ù…Ø¬Ù„Ø© Ø¹Ø§Ù…Ø©"
                        }),
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        console.error("ØªÙØ§ØµÙŠÙ„ Ø®Ø·Ø£ Ø§Ù„Ø¯Ø§Ù„Ø© (Edge Function):", errText);
                        throw new Error(`Server Error: ${response.status} - ${errText}`);
                    }

                    const data = await response.json();
                    setMsgs(p => [...p, { role: 'model', text: data.reply }]);
                } catch (err) {
                    console.error("ChatBot Error:", err);
                    setMsgs(p => [...p, { role: 'model', text: `Ù…Ø¹Ù„Ø´ ÙŠØ§ Ø¨Ø·Ù„ØŒ Ø­ØµÙ„Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. (Ø±Ù…Ø² Ø§Ù„Ø®Ø·Ø£: ${err.message})` }]);
                }
                setLoading(false);
            };

            const handleTextSend = (e) => {
                e.preventDefault();
                if(!input.trim()) return;
                setMsgs(p => [...p, { role: 'user', text: input }]);
                sendPayload(input);
                setInput("");
            };

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-gray-900">
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {msgs.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 text-sm shadow-md whitespace-pre-wrap ${m.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`}>
                                    {m.text}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-xs text-gray-400 p-2 animate-pulse">Ø¹Ù…Ùˆ ÙÙ‡ÙŠÙ… Ø¨ÙŠÙƒØªØ¨...</div>}
                        <div ref={endRef}></div>
                    </div>
                    <div className="p-2 bg-white dark:bg-gray-800 border-t flex gap-2 items-center">
                        <form onSubmit={handleTextSend} className="flex-1 flex gap-2">
                            <input value={input} onChange={e => setInput(e.target.value)} placeholder={t.chatPlaceholder} className="flex-1 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-full px-4 py-2" />
                            <button type="submit" className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center transform rotate-180 hover:bg-indigo-700 transition">â¤</button>
                        </form>
                    </div>
                </div>
            );
        }

        function QuizView({ issue, t }) {
            const [state, setState] = React.useState('setup');
            const [qCount, setQCount] = React.useState(5);
            const [difficulty, setDifficulty] = React.useState('Medium');
            const [qSource, setQSource] = React.useState('inside'); 
            const [qType, setQType] = React.useState('religious'); 
            const [questions, setQuestions] = React.useState([]);
            const [idx, setIdx] = React.useState(0);
            const [score, setScore] = React.useState(0);

            const startQuiz = async () => {
                setState('loading');
                const topic = issue.title.ar;
                let prompt = "";
                if (qSource === 'inside') {
                    prompt = `Generate ${qCount} multiple choice questions in Arabic based strictly on the topic "${topic}" (religious/church context). Difficulty: ${difficulty}.`;
                } else {
                    prompt = `Generate ${qCount} multiple choice questions in Arabic about "${topic}" but focusing on ${qType === 'scientific' ? 'Scientific facts/General knowledge' : 'General Christian/Orthodox knowledge'}. Difficulty: ${difficulty}.`;
                }
                prompt += ` Format must be valid JSON: [{"q":"Question text","o":["Option A","Option B","Option C"],"a":0}]. Do not use markdown blocks.`;
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                    });
                    if(!res.ok) throw new Error("Failed");
                    const data = await res.json();
                    let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "[]";
                    text = text.replace(/```json|```/g, '').trim(); 
                    const json = JSON.parse(text);
                    if(json.length > 0) { setQuestions(json); setIdx(0); setScore(0); setState('play'); }
                    else { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©."); setState('setup'); }
                } catch(e) { 
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."); 
                    setState('setup'); 
                }
            };

            const answer = (i) => {
                if(i === questions[idx].a) setScore(s => s+1);
                if(idx < questions.length - 1) setIdx(n => n+1); else setState('end');
            };

            if(state === 'setup') return (
                <div className="h-full flex flex-col items-center justify-center p-6 bg-indigo-50 dark:bg-gray-900 text-center overflow-y-auto">
                    <div className="text-6xl mb-2">ğŸ†</div>
                    <h2 className="text-2xl font-bold mb-4 dark:text-white">{t.quizSetup}</h2>
                    <div className="w-full max-w-xs space-y-4 mb-6 text-right">
                        <div><label className="block text-xs font-bold mb-1 dark:text-gray-300">{t.qCount} {qCount}</label><input type="range" min="3" max="10" value={qCount} onChange={e=>setQCount(e.target.value)} className="w-full accent-indigo-600" /></div>
                        <div><label className="block text-xs font-bold mb-1 dark:text-gray-300">{t.qDiff}</label><div className="flex gap-1">{['Easy','Medium','Hard'].map(d => <button key={d} onClick={()=>setDifficulty(d)} className={`flex-1 py-2 rounded-lg text-xs font-bold border ${difficulty===d ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600'}`}>{TRANSLATIONS.ar['diff'+d] || d}</button>)}</div></div>
                        <div><label className="block text-xs font-bold mb-1 dark:text-gray-300">{t.qSource}</label><div className="flex gap-1">
                            <button onClick={()=>setQSource('inside')} className={`flex-1 py-2 rounded-lg text-xs font-bold border ${qSource==='inside' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600'}`}>{t.qSrcInside}</button>
                            <button onClick={()=>setQSource('outside')} className={`flex-1 py-2 rounded-lg text-xs font-bold border ${qSource==='outside' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600'}`}>{t.qSrcOutside}</button>
                        </div></div>
                        {qSource === 'outside' && (
                           <div><label className="block text-xs font-bold mb-1 dark:text-gray-300">{t.qType}</label><div className="flex gap-1">
                                <button onClick={()=>setQType('religious')} className={`flex-1 py-2 rounded-lg text-xs font-bold border ${qType==='religious' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600'}`}>{t.qTypeRel}</button>
                                <button onClick={()=>setQType('scientific')} className={`flex-1 py-2 rounded-lg text-xs font-bold border ${qType==='scientific' ? 'bg-purple-600 text-white' : 'bg-white text-gray-600'}`}>{t.qTypeSci}</button>
                            </div></div> 
                        )}
                    </div>
                    <button onClick={startQuiz} className="w-full max-w-xs bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:scale-105 transition">{t.startQuiz}</button>
                </div>
            );
            
            if(state === 'loading') return <div className="h-full flex flex-col items-center justify-center font-bold animate-pulse dark:text-white"><div className="text-4xl mb-2">ğŸ¤”</div><div>Ø¹Ù…Ùˆ ÙÙ‡ÙŠÙ… Ø¨ÙŠØ¬Ù‡Ø² Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</div></div>;
            
            if(state === 'play') return (
                <div className="h-full p-6 flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900">
                    <div className="w-full max-w-md">
                        <div className="flex justify-between mb-4 font-bold text-indigo-900 dark:text-indigo-300"><span>Ø³Ø¤Ø§Ù„ {idx+1}/{questions.length}</span><span>Ø§Ù„Ù†Ù‚Ø§Ø·: {score}</span></div>
                        <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg mb-6 min-h-[150px] flex items-center justify-center text-center"><h3 className="text-lg font-bold dark:text-white leading-relaxed">{questions[idx].q}</h3></div>
                        <div className="space-y-3">{questions[idx].o.map((opt, i) => <button key={i} onClick={()=>answer(i)} className="w-full p-4 bg-white dark:bg-gray-800 border-2 border-transparent hover:border-indigo-500 rounded-xl shadow-sm font-bold text-gray-700 dark:text-gray-200 transition">{opt}</button>)}</div>
                    </div>
                </div>
            );
            return (
                <div className="h-full flex flex-col items-center justify-center p-6 text-center dark:text-white">
                    <div className="text-6xl mb-4">ğŸ‰</div>
                    <h2 className="text-3xl font-black mb-2">{t.score}</h2>
                    <div className="text-5xl font-black text-indigo-600 mb-8">{score} / {questions.length}</div>
                    <button onClick={()=>setState('setup')} className="bg-gray-200 dark:bg-gray-700 px-8 py-3 rounded-xl font-bold">{t.playAgain}</button>
                </div>
            );
        }

        function IssueDetail({ issue, onBack, t }) {
            const [tab, setTab] = React.useState("mag");
            return (
                <div className="h-screen flex flex-col bg-white dark:bg-gray-900">
                    <div className="flex items-center justify-between p-3 border-b dark:border-gray-800 shadow-sm z-20">
                        <button onClick={onBack} className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center font-bold text-indigo-600 transform rotate-180">âœ</button>
                        <div className="text-sm font-bold truncate px-2 dark:text-white">{issue.title.ar}</div>
                        <div className="w-10"></div>
                    </div>
                    <div className="flex justify-around bg-indigo-50 dark:bg-gray-800 p-1">
                        <button onClick={()=>setTab('mag')} className={`flex-1 py-2 text-xs font-bold rounded-lg ${tab==='mag'?'bg-white text-indigo-600 shadow':'text-gray-500'}`}>ğŸ“– Ø§Ù„Ù…Ø¬Ù„Ø©</button>
                        <button onClick={()=>setTab('video')} className={`flex-1 py-2 text-xs font-bold rounded-lg ${tab==='video'?'bg-white text-indigo-600 shadow':'text-gray-500'}`}>ğŸ“º ÙÙŠØ¯ÙŠÙˆ</button>
                        <button onClick={()=>setTab('chat')} className={`flex-1 py-2 text-xs font-bold rounded-lg ${tab==='chat'?'bg-white text-indigo-600 shadow':'text-gray-500'}`}>ğŸ¤– ÙÙ‡ÙŠÙ…</button>
                        {/* âœ… Ø²Ø± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© */}
                        <button onClick={()=>setTab('quiz')} className={`flex-1 py-2 text-xs font-bold rounded-lg ${tab==='quiz'?'bg-white text-indigo-600 shadow':'text-gray-500'}`}>{t.quizTab}</button>
                    </div>
                    <div className="flex-1 bg-gray-100 dark:bg-black relative overflow-hidden">
                        {tab === 'mag' && <iframe src={issue.magazine_url} className="w-full h-full border-none bg-white"></iframe>}
                        {tab === 'video' && <div className="h-full overflow-y-auto p-4 space-y-4">
                            {issue.videos && issue.videos.length > 0 ? issue.videos.map((v, i) => {
                                const embed = getYoutubeEmbed(v.url);
                                return (
                                    <div key={i} className="bg-white dark:bg-gray-800 rounded-2xl overflow-hidden shadow-lg">
                                        <div className="aspect-video bg-black">{embed && <iframe src={embed} className="w-full h-full" allowFullScreen></iframe>}</div>
                                        <div className="p-3 font-bold dark:text-white">{v.title.ar}</div>
                                    </div>
                                );
                            }) : <div className="text-center py-10 opacity-50 dark:text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</div>}
                        </div>}
                        {tab === 'chat' && <ChatBot t={t} issueContext={issue.title.ar} />}
                        {tab === 'quiz' && <QuizView issue={issue} t={t} />}
                    </div>
                </div>
            );
        }

        function LoginView({ onLogin, error, processing, t }) {
            const [code, setCode] = React.useState("");
            const [scanning, setScanning] = React.useState(false);
            const startScan = () => {
                setScanning(true); setTimeout(() => {
                    const scanner = new Html5Qrcode("reader");
                    scanner.start({ facingMode: "environment" }, { fps: 10 }, (decoded) => { scanner.stop(); setScanning(false); onLogin(decoded); }, () => {});
                }, 100);
            };
            return (
                <div className="flex flex-col items-center text-center">
                    <h2 className="text-2xl font-bold mb-4 dark:text-white">{t.loginTitle}</h2>
                    {scanning ? <div id="reader" className="w-full h-64 bg-black mb-4"></div> : <button onClick={startScan} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold mb-4">{t.scanBtn}</button>}
                    <input value={code} onChange={e=>setCode(e.target.value.toUpperCase())} placeholder={t.manualBtn} className="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700 dark:text-white text-center font-bold mb-3 border-2" />
                    <button onClick={()=>onLogin(code)} disabled={processing} className="w-full py-3 bg-yellow-400 font-bold rounded-xl">{processing ? "..." : t.activateBtn}</button>
                    {error && <div className="mt-4 text-red-600 font-bold">{error}</div>}
                </div>
            );
        }

        function App() {
            const [view, setView] = React.useState("home");
            const [lang, setLang] = React.useState(localStorage.getItem('bejouri_lang') || 'ar');
            const [theme, setTheme] = React.useState(localStorage.getItem('bejouri_theme') || 'light');
            const [issues, setIssues] = React.useState([]);
            const [unlocked, setUnlocked] = React.useState(JSON.parse(localStorage.getItem('bejouri_unlocked') || '[]'));
            const [activeIssue, setActiveIssue] = React.useState(null);
            const [showLogin, setShowLogin] = React.useState(false);
            const [targetId, setTargetId] = React.useState(null);
            const [loginError, setLoginError] = React.useState("");
            const [verifying, setVerifying] = React.useState(false);
            const [chatOpen, setChatOpen] = React.useState(false);
            const [appBg, setAppBg] = React.useState('');
            const [appLogo, setAppLogo] = React.useState('');
            const [introData, setIntroData] = React.useState({}); 
            const [showIntro, setShowIntro] = React.useState(true); 
            
            const t = TRANSLATIONS[lang];

            React.useEffect(() => {
                if (theme === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
                localStorage.setItem('bejouri_theme', theme);
                document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                localStorage.setItem('bejouri_lang', lang);

                const fetchData = async () => {
                    const { data: settings } = await supabase.from('settings').select('value').eq('key', 'config').single();
                    if (settings) {
                        if (settings.value.appBackground) setAppBg(`url("${settings.value.appBackground}")`);
                        if (settings.value.appLogo) setAppLogo(settings.value.appLogo);
                        setIntroData({ 
                            title: settings.value.introTitle, 
                            body: settings.value.introBody 
                        });
                    }
                    const { data: issuesData } = await supabase.from('issues').select('*').order('created_at', { ascending: false });
                    if (issuesData) setIssues(issuesData);
                };
                fetchData();
            }, [lang, theme]);

            const handleUnlock = async (code) => {
                setVerifying(true); setLoginError("");
                const res = await checkCodeOnline(code, targetId);
                if(res.success) {
                    const newUnlocked = [...unlocked, targetId];
                    setUnlocked(newUnlocked);
                    localStorage.setItem('bejouri_unlocked', JSON.stringify(newUnlocked));
                    setActiveIssue(issues.find(i => i.id === targetId));
                    setShowLogin(false); setView("issue");
                } else {
                    if(res.error === "USED") setLoginError(t.errUsed); else if(res.error === "WRONG_ISSUE") setLoginError(t.errWrong); else setLoginError(t.errInvalid);
                }
                setVerifying(false);
            };

            const toggleTheme = () => setTheme(prev => prev === 'light' ? 'dark' : 'light');
            const toggleLang = () => setLang(prev => prev === 'ar' ? 'en' : 'ar');

            if (chatOpen) return ( <div className="h-screen flex flex-col"> <button onClick={() => setChatOpen(false)} className="p-4 bg-indigo-600 text-white font-bold">Ø±Ø¬ÙˆØ¹ ğŸ”™</button> <ChatBot t={t} /> </div> );
            if(view === "issue" && activeIssue) return <IssueDetail issue={activeIssue} onBack={()=>setView("home")} t={t} />;

            return (
                <div className="min-h-screen relative text-gray-900 dark:text-white font-sans transition-colors duration-300">
                    {showIntro && <IntroModal onClose={() => setShowIntro(false)} data={introData} t={t} />}

                    <div className="app-bg" style={{ backgroundImage: appBg }}></div>
                    
                    {/* Header */}
                    <div className="sticky top-0 z-10 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md p-4 shadow-sm flex justify-between items-center rounded-b-2xl mx-2 mt-2">
                        <div className="flex items-center gap-4"> {/* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ù‡Ù†Ø§ */}
                            {appLogo && <img src={appLogo} alt="Logo" className="h-20 w-20 object-contain drop-shadow-md" />} {/* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù„ÙˆØ¬Ùˆ ÙˆØ¥Ø¶Ø§ÙØ© Ø¸Ù„ */}
                            <div>
                                <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 drop-shadow-sm tracking-tight">{t.appTitle}</h1> {/* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· ÙˆØªÙ„ÙˆÙŠÙ†Ù‡ */}
                                <p className="text-sm font-bold text-gray-500 dark:text-gray-400 mt-1">{t.subTitle}</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={toggleLang} className="bg-indigo-100 dark:bg-indigo-800 dark:text-white px-3 py-1 rounded-lg font-bold text-xs transition hover:scale-105">{t.langBtn}</button>
                            <button onClick={toggleTheme} className="w-10 h-10 bg-indigo-50 dark:bg-gray-700 rounded-full flex items-center justify-center shadow transition hover:scale-105 text-xl">{theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
                            <button onClick={() => setChatOpen(true)} className="w-10 h-10 bg-green-500 dark:bg-green-700 rounded-full flex items-center justify-center shadow transition hover:scale-105 text-xl">ğŸ¤–</button>
                        </div>
                    </div>

                    <div className="p-4 space-y-4 pb-20 relative z-0">
                        {/* âœ… Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© */}
                        {issues.length > 0 && issues[0].verse && issues[0].verse.text && (
                            <div className="flex items-start gap-3 animate-fade-in my-8">
                                <div className="w-12 h-12 bg-indigo-500 rounded-full flex items-center justify-center text-2xl shadow-md border-2 border-indigo-100 text-white z-10">âœï¸</div>
                                <div className="flex-1 verse-bubble p-4 shadow-xl">
                                    <h4 className="text-xs font-bold text-indigo-600 dark:text-indigo-400 mb-1">{t.verseTitle}</h4>
                                    <p className="text-sm font-bold leading-relaxed text-gray-800 dark:text-gray-200">"{issues[0].verse.text}"</p>
                                    <div className="text-right text-xs text-gray-500 dark:text-gray-400 mt-2 font-bold">â€” {issues[0].verse.ref}</div>
                                </div>
                            </div>
                        )}

                        {issues.length === 0 && <div className="text-center bg-white/80 p-8 rounded-2xl">{t.loading}</div>}
                        
                        {/* âœ… ØªØµÙ…ÙŠÙ… Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ */}
                        {issues.map(issue => {
                            const isOpen = unlocked.includes(issue.id) || issue.is_free;
                            return (
                                <div key={issue.id} onClick={() => isOpen ? (setActiveIssue(issue), setView("issue")) : (setTargetId(issue.id), setShowLogin(true), setLoginError(""))}
                                     className="relative overflow-hidden bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 transform transition hover:-translate-y-1 cursor-pointer group">
                                    
                                    <div className="flex h-36"> {/* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */}
                                        
                                        {/* Ù‚Ø³Ù… Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†) */}
                                        <div className="w-32 shrink-0 relative overflow-hidden">
                                            {issue.background ? (
                                                <img src={issue.background} className="w-full h-full object-cover transition duration-500 group-hover:scale-110" alt="Cover" />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-5xl bg-indigo-50 text-indigo-300">ğŸ“–</div>
                                            )}
                                        </div>

                                        {/* Ù‚Ø³Ù… Ø§Ù„Ù†ØµÙˆØµ (Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±) Ø¨Ø®Ù„ÙÙŠØ© Ø³Ø§Ø¯Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© */}
                                        <div className="flex-1 p-5 flex flex-col justify-center bg-gradient-to-l from-gray-50 to-white dark:from-gray-800 dark:to-gray-900">
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-xs font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded-md">{issue.date?.ar}</span>
                                                {isOpen && <span className={`text-xs px-2 py-1 rounded-full font-bold ${issue.is_free ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}>{issue.is_free ? t.free : t.open}</span>}
                                            </div>
                                            <h3 className="text-2xl font-black text-gray-800 dark:text-white leading-tight mb-1">{issue.title.ar}</h3>
                                            <p className="text-xs text-gray-400 font-bold">Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙØ­</p>
                                        </div>
                                    </div>

                                    {/* Ø·Ø¨Ù‚Ø© Ø§Ù„Ù‚ÙÙ„ (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØºÙ„Ù‚Ø§Ù‹) */}
                                    {!isOpen && <div className="absolute inset-0 bg-white/30 dark:bg-black/50 backdrop-blur-[1px] flex flex-col items-center justify-center z-10">
                                        <div className="bg-white/90 dark:bg-gray-900/90 p-3 rounded-full shadow-xl animate-bounce"><span className="text-2xl">ğŸ”’</span></div>
                                    </div>}
                                </div>
                            );
                        })}
                    </div>

                    {showLogin && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                            <div className="bg-white dark:bg-gray-900 w-full max-w-md p-6 rounded-3xl relative animate-pop-in shadow-2xl">
                                <button onClick={()=>setShowLogin(false)} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-xl">âœ•</button>
                                <LoginView onLogin={handleUnlock} error={loginError} processing={verifying} t={t} />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>