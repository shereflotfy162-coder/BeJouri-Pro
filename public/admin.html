<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… BeØ¬ÙˆØ±ÙŠ - Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .tab-btn { transition: all 0.3s; }
        .tab-btn.active { background-color: #2563eb; color: white; transform: scale(1.05); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media print { 
            .no-print { display: none !important; } 
            .qr-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; } 
            .qr-card { border: 2px dashed #000; padding: 10px; text-align: center; page-break-inside: avoid; } 
        }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const SUPABASE_URL = "https://ozdnyepxfcjzldpkteau.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96ZG55ZXB4ZmNqemxkcGt0ZWF1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NDEwNTM3MiwiZXhwIjoyMDc5NjgxMzcyfQ.mtqFcdRZeidpC0Ul8r_8FJOJalToT4lZeHNqd3-fsOg";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let adminPassword = "123";
        let internalPassword = "456";
        const BACKUP_PASSWORDS = ["Admin@2025"];

        function compressImage(file) { return new Promise((r) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const w = Math.min(img.width, 1000); const h = img.height * (w / img.width); canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h); canvas.toBlob((b) => r(new File([b], file.name, { type: 'image/jpeg' })), 'image/jpeg', 0.7); }; }; }); }
        async function uploadFile(file) { if (!file) return null; const compressed = await compressImage(file); const name = `${Date.now()}_${Math.random().toString(36).substring(2)}.jpg`; const { error } = await supabase.storage.from('images').upload(name, compressed); if (error) throw error; return supabase.storage.from('images').getPublicUrl(name).data.publicUrl; }
        async function generateCodesLogic(issueId, count) { const c = []; for(let i=0; i<count; i++) c.push({code: `BJ-${issueId}-${Math.floor(10000+Math.random()*90000)}`, issue_id: parseInt(issueId)}); await supabase.from('codes').insert(c); }
        const generateQrDataUrl = (value) => { if(!window.QRious) return ''; const c = document.createElement('canvas'); new QRious({element: c, value, size: 120}); return c.toDataURL(); };

        function LoginView({ onLogin }) {
            const [pass, setPass] = React.useState('');
            return <div className="h-screen flex items-center justify-center"><div className="bg-white p-8 rounded-xl shadow-xl text-center border-t-4 border-blue-600"><h2 className="text-2xl font-bold mb-4">ğŸ” Ø§Ù„Ø£Ø¯Ù…Ù†</h2><input type="password" value={pass} onChange={e=>setPass(e.target.value)} className="border p-2 rounded w-full mb-4" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"/><button onClick={()=>{if(pass===adminPassword||BACKUP_PASSWORDS.includes(pass)) onLogin(true); else alert('Ø®Ø·Ø£');}} className="bg-blue-600 text-white px-4 py-2 rounded w-full">Ø¯Ø®ÙˆÙ„</button></div></div>;
        }

        function InternalLockView({ onUnlock }) {
            const [pass, setPass] = React.useState('');
            return <div className="flex flex-col items-center justify-center h-full p-10 text-center animate-fade-in"><div className="bg-white p-10 rounded-3xl shadow-2xl border border-red-100 max-w-md w-full"><div className="text-6xl mb-4">ğŸ›¡ï¸</div><h2 className="text-2xl font-black text-gray-800 mb-2">Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ù…ÙŠØ©</h2><p className="text-gray-500 mb-6 text-sm">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</p><input type="password" value={pass} onChange={e => setPass(e.target.value)} className="w-full p-4 bg-gray-50 border-2 rounded-xl mb-4 text-center text-lg font-bold outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/><button onClick={()=>{if(pass===internalPassword||BACKUP_PASSWORDS.includes(pass)) onUnlock(); else alert('Ø®Ø·Ø£');}} className="w-full bg-red-600 text-white font-bold py-4 rounded-xl">ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ ğŸ”“</button></div></div>;
        }

        function OverviewTab({ refresh }) {
            const [friends, setFriends] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            React.useEffect(() => {
                const f = async () => { setLoading(true); const { data } = await supabase.from('children').select('*').order('created_at', { ascending: false }); setFriends(data || []); setLoading(false); };
                f();
            }, [refresh]);
            const deleteFriend = async (id) => { if(!confirm('Ø­Ø°ÙØŸ')) return; await supabase.from('children').delete().eq('id', id); window.location.reload(); };
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-6 rounded-2xl shadow border-t-4 border-indigo-500 text-center"><h3 className="font-bold text-gray-600">Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø© Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h3><div className="text-4xl font-black text-indigo-600">{friends.length}</div></div>
                    <div className="bg-white p-6 rounded-2xl shadow"><h3 className="font-bold text-xl mb-4">ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h3><div className="overflow-x-auto"><table className="w-full text-right text-sm"><thead className="bg-gray-100"><tr><th className="p-3">Ø§Ù„Ø§Ø³Ù…</th><th className="p-3">Ø§Ù„ØµÙ</th><th className="p-3">Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</th><th className="p-3">Ø§Ù„Ù…ÙˆÙ‡Ø¨Ø©</th><th className="p-3">Ø­Ø°Ù</th></tr></thead><tbody>{loading ? <tr><td colSpan="5" className="p-4 text-center">...</td></tr> : friends.map(f => (<tr key={f.id} className="border-b hover:bg-gray-50"><td className="p-3 font-bold">{f.full_name}</td><td className="p-3">{f.grade}</td><td className="p-3 font-mono">{f.phone}</td><td className="p-3 text-purple-600 font-bold">{f.talent}</td><td className="p-3"><button onClick={()=>deleteFriend(f.id)} className="text-red-500">ğŸ—‘ï¸</button></td></tr>))}</tbody></table></div></div>
                </div>
            );
        }

        function ContestResultsTab({ issues, refresh }) {
            const [results, setResults] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            
            React.useEffect(() => {
                const fetchResults = async () => { 
                    setLoading(true); 
                    const { data, error } = await supabase.from('contest_submissions').select('*').order('created_at', { ascending: false }); 
                    
                    if (error) {
                        console.error("Error fetching contest results:", error.message);
                    }
                    if (data) {
                        const issuesMap = issues.reduce((acc, issue) => {
                            acc[issue.id] = issue.title.ar;
                            return acc;
                        }, {});

                        const mergedData = data.map(result => ({
                            ...result,
                            issueTitle: issuesMap[result.issue_id] || `#${result.issue_id}`
                        }));
                        setResults(mergedData); 
                    } else {
                        setResults([]);
                    }
                    setLoading(false); 
                };
                if (issues.length > 0) {
                    fetchResults();
                }
            }, [refresh, issues]); 

            const deleteResult = async (id) => { if(!confirm('Ø­Ø°ÙØŸ')) return; await supabase.from('contest_submissions').delete().eq('id', id); setResults(p => p.filter(r => r.id !== id)); };
            
            // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµÙÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const resetAllContestData = async () => {
                if (!confirm('ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) return;
                setLoading(true);
                try {
                    const { error } = await supabase.from('contest_submissions').delete().not('id', 'is', null);
                    if (error) throw error;
                    setResults([]);
                    alert("ØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­.");
                    // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù€ refreshToggle Ù‡Ù†Ø§ØŒ ÙŠÙƒÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                } catch(e) {
                    alert("ÙØ´Ù„ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="bg-white p-6 rounded-2xl shadow animate-fade-in border-t-4 border-purple-500">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-xl text-purple-800">ğŸ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ({results.length})</h3>
                        <button onClick={resetAllContestData} disabled={loading} className="bg-red-500 text-white px-4 py-2 rounded-xl font-bold shadow-md hover:bg-red-600 transition disabled:bg-gray-400">
                            ğŸ—‘ï¸ ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-right text-sm">
                            <thead className="bg-purple-50">
                                <tr>
                                    <th className="p-3">Ø§Ù„Ø§Ø³Ù…</th>
                                    <th className="p-3">Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</th>
                                    <th className="p-3">Ø§Ù„ØµÙ</th>
                                    <th className="p-3">Ø§Ù„Ø¹Ø¯Ø¯</th>
                                    <th className="p-3">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                    <th className="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th className="p-3">Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody>
                                {loading ? <tr><td colSpan="7" className="p-4">...</td></tr> : results.map(r => (
                                    <tr key={r.id} className="border-b">
                                        <td className="p-3 font-bold">{r.student_name}</td>
                                        <td className="p-3 font-mono">{r.student_phone}</td>
                                        <td className="p-3 text-gray-600">{r.student_grade || '-'}</td> 
                                        <td className="p-3 text-indigo-600 font-bold">{r.issueTitle || `#${r.issue_id}`}</td>
                                        <td className="p-3 font-black text-green-600">{r.score}/{r.total}</td>
                                        <td className="p-3 text-gray-500">{new Date(r.created_at).toLocaleDateString('ar-EG')}</td>
                                        <td className="p-3"><button onClick={()=>deleteResult(r.id)} className="text-red-500">âŒ</button></td>
                                    </tr>
                                ))}
                                {!loading && results.length === 0 && (
                                     <tr><td colSpan="7" className="p-4 text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function RiddlesLeaderboardTab({ refresh }) {
            const [leaders, setLeaders] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            
            React.useEffect(() => {
                const fetchLeaders = async () => {
                    setLoading(true);
                    const { data } = await supabase.from('riddles_scores').select('*').order('score', { ascending: false }).limit(10);
                    setLeaders(data || []);
                    setLoading(false);
                };
                fetchLeaders();
            }, [refresh]);
            
            // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµÙÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const resetAllRiddlesData = async () => {
                 if (!confirm('ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„ÙÙˆØ§Ø²ÙŠØ±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) return;
                setLoading(true);
                try {
                    const { error } = await supabase.from('riddles_scores').delete().not('id', 'is', null);
                    if (error) throw error;
                    setLeaders([]);
                    alert("ØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„ÙÙˆØ§Ø²ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.");
                } catch(e) {
                    alert("ÙØ´Ù„ ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded-2xl shadow animate-fade-in border-t-4 border-yellow-500">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-xl text-yellow-800">ğŸ¥‡ Ù„ÙˆØ­Ø© Ø´Ø±Ù Ø§Ù„ÙÙˆØ§Ø²ÙŠØ± ({leaders.length} Ø¨Ø·Ù„)</h3>
                         <button onClick={resetAllRiddlesData} disabled={loading} className="bg-red-500 text-white px-4 py-2 rounded-xl font-bold shadow-md hover:bg-red-600 transition disabled:bg-gray-400">
                            ğŸ—‘ï¸ ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-right text-sm">
                            <thead className="bg-yellow-50">
                                <tr>
                                    <th className="p-3">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                                    <th className="p-3">Ø§Ø³Ù… Ø§Ù„Ø¨Ø·Ù„</th>
                                    <th className="p-3">Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                    <th className="p-3">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
                                </tr>
                            </thead>
                            <tbody>
                                {loading ? <tr><td colSpan="4" className="p-4">...</td></tr> : leaders.map((l, index) => (
                                    <tr key={l.id} className="border-b">
                                        <td className="p-3 font-black text-lg text-purple-600">#{index + 1}</td>
                                        <td className="p-3 font-bold text-gray-800">{l.user_name}</td>
                                        <td className="p-3 font-black text-green-600">{l.score}</td>
                                        <td className="p-3 text-gray-500 text-xs">{new Date(l.last_update).toLocaleString('ar-EG')}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function IssuesTab({ issues, refresh }) {
            const [issueData, setIssueData] = React.useState({ id: '', title: '', date: '', magUrl: '', verseText: '', verseRef: '', isFree: false, backgroundUrl: '', backgroundFile: null, videos: [{ title: '', url: '' }], contestQuestions: [], hideMagazine: false });
            const [editingId, setEditingId] = React.useState(null);
            const [loading, setLoading] = React.useState(false);

            const handleAddQuestion = () => setIssueData(p => ({ ...p, contestQuestions: [...p.contestQuestions, { question: '', answer: '', options: '' }] }));
            const handleQChange = (i, field, val) => { const q = [...issueData.contestQuestions]; q[i][field] = val; setIssueData(p => ({ ...p, contestQuestions: q })); };
            const handleRemoveQ = (i) => setIssueData(p => ({ ...p, contestQuestions: p.contestQuestions.filter((_, idx) => idx !== i) }));
            const handleAddVideo = () => setIssueData(p => ({ ...p, videos: [...p.videos, { title: '', url: '' }] }));
            const handleVideoChange = (i, field, val) => { const v = [...issueData.videos]; v[i][field] = val; setIssueData(p => ({ ...p, videos: v })); };

            const startEdit = (issue) => { 
                setEditingId(issue.id); 
                const questions = (issue.contest || []).map(q => ({ ...q, options: Array.isArray(q.options) ? q.options.join(',') : (q.options || '') }));
                setIssueData({ id: issue.id, title: issue.title?.ar, date: issue.date?.ar, magUrl: issue.magazine_url, verseText: issue.verse?.text, verseRef: issue.verse?.ref, isFree: issue.is_free, backgroundUrl: issue.background, backgroundFile: null, videos: issue.videos || [], contestQuestions: questions, hideMagazine: issue.hide_magazine }); 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const saveIssue = async () => {
                setLoading(true);
                try {
                    let bg = issueData.backgroundUrl;
                    if(issueData.backgroundFile) bg = await uploadFile(issueData.backgroundFile);
                    const formattedContest = issueData.contestQuestions.map(q => ({ question: q.question, answer: q.answer, options: q.options ? q.options.split(',').map(o => o.trim()).filter(o => o) : [] })).filter(q => q.question && q.answer);
                    const payload = { title: {ar: issueData.title}, date: {ar: issueData.date}, magazine_url: issueData.magUrl, verse: {text: issueData.verseText, ref: issueData.verseRef}, is_free: issueData.isFree, background: bg, videos: issueData.videos.filter(v=>v.url), contest: formattedContest, hide_magazine: issueData.hideMagazine };
                    if(editingId) await supabase.from('issues').update(payload).eq('id', editingId); else await supabase.from('issues').insert([{id: issueData.id, ...payload}]);
                    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); setEditingId(null); setIssueData({id:'',title:'',date:'',magUrl:'',verseText:'',verseRef:'',isFree:false,backgroundUrl:'',videos:[{title:'',url:''}],contestQuestions:[],hideMagazine:false}); refresh();
                } catch(e) { alert('Ø®Ø·Ø£: ' + e.message); } finally { setLoading(false); }
            };
            const deleteIssue = async (id) => { if(confirm('Ø­Ø°ÙØŸ')) { await supabase.from('issues').delete().eq('id', id); refresh(); } };

            return (
                <div className="grid lg:grid-cols-3 gap-6 animate-fade-in">
                    <div className="lg:col-span-1 bg-white p-6 rounded-2xl shadow border-t-4 border-blue-600 h-fit">
                        <h2 className="font-bold text-lg mb-4">{editingId ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯'}</h2>
                        <div className="space-y-3">
                            <input value={issueData.id} onChange={e=>setIssueData({...issueData, id: e.target.value})} disabled={!!editingId} placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø¯ (ID)" className="w-full border p-2 rounded"/>
                            <input value={issueData.title} onChange={e=>setIssueData({...issueData, title: e.target.value})} placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" className="w-full border p-2 rounded"/>
                            <input value={issueData.date} onChange={e=>setIssueData({...issueData, date: e.target.value})} placeholder="Ø§Ù„ØªØ§Ø±ÙŠØ®" className="w-full border p-2 rounded"/>
                            <input value={issueData.magUrl} onChange={e=>setIssueData({...issueData, magUrl: e.target.value})} placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¬Ù„Ø©" className="w-full border p-2 rounded"/>
                            
                            <div className="space-y-2 bg-gray-50 p-2 rounded border">
                                <label className="text-xs font-bold block mb-1">ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù:</label>
                                <input value={issueData.backgroundUrl || ''} onChange={e => { setIssueData(p => ({ ...p, backgroundUrl: e.target.value })); setIssueData(p => ({...p, backgroundFile: null})); }} placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±" className="w-full border p-2 rounded text-sm mb-1"/>
                                <input type="file" onChange={e => { setIssueData(p => ({ ...p, backgroundFile: e.target.files[0], backgroundUrl: '' })); }} className="w-full text-sm"/>
                            </div>

                            <div className="bg-gray-50 p-2 rounded border">
                                <label className="text-xs font-bold block mb-1">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø¯Ø¯:</label>
                                {issueData.contestQuestions.map((q, i) => (
                                    <div key={i} className="mb-2 border-b pb-2">
                                        <div className="flex gap-1 mb-1"><input value={q.question} onChange={e=>handleQChange(i,'question',e.target.value)} placeholder="Ø§Ù„Ø³Ø¤Ø§Ù„" className="w-full border p-1 rounded text-sm"/><button onClick={()=>handleRemoveQ(i)} className="text-red-500">âœ•</button></div>
                                        <input value={q.answer} onChange={e=>handleQChange(i,'answer',e.target.value)} placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©" className="w-full border p-1 rounded text-sm mb-1 bg-green-50"/>
                                        <input value={q.options} onChange={e=>handleQChange(i,'options',e.target.value)} placeholder="Ø§Ø®ØªÙŠØ§Ø±Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)" className="w-full border p-1 rounded text-sm bg-yellow-50"/>
                                    </div>
                                ))}
                                <button onClick={handleAddQuestion} className="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">+ Ø³Ø¤Ø§Ù„</button>
                            </div>
                            <div className="bg-gray-50 p-2 rounded border">
                                <label className="text-xs font-bold block mb-1">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª:</label>
                                {issueData.videos.map((v, i) => (<div key={i} className="flex gap-1 mb-1"><input value={v.title} onChange={e=>handleVideoChange(i,'title',e.target.value)} placeholder="Ø¹Ù†ÙˆØ§Ù†" className="w-1/2 border p-1"/><input value={v.url} onChange={e=>handleVideoChange(i,'url',e.target.value)} placeholder="Ø±Ø§Ø¨Ø·" className="w-1/2 border p-1"/></div>))}
                                <button onClick={handleAddVideo} className="text-xs text-blue-600">+ ÙÙŠØ¯ÙŠÙˆ</button>
                            </div>
                            <div className="flex flex-col gap-2">
                                <label className="flex items-center gap-2"><input type="checkbox" checked={issueData.isFree} onChange={e=>setIssueData({...issueData, isFree: e.target.checked})} /> <span>Ù…Ø¬Ø§Ù†ÙŠ</span></label>
                                <label className="flex items-center gap-2"><input type="checkbox" checked={issueData.hideMagazine} onChange={e=>setIssueData({...issueData, hideMagazine: e.target.checked})} /> <span>Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø©</span></label>
                            </div>
                            <button onClick={saveIssue} disabled={loading} className="w-full bg-blue-600 text-white py-2 rounded">{loading?'...':'Ø­ÙØ¸'}</button>
                            {editingId && <button onClick={()=>setEditingId(null)} className="w-full bg-gray-200 py-2 rounded mt-2">Ø¥Ù„ØºØ§Ø¡</button>}
                        </div>
                    </div>
                    <div className="lg:col-span-2 space-y-4">
                        {issues.map(iss => (
                            <div key={iss.id} className="bg-white p-4 rounded-xl shadow flex justify-between items-center">
                                <div><div className="font-bold">#{iss.id} {iss.title?.ar}</div><div className="text-xs text-gray-500">{iss.contest?.length || 0} Ø£Ø³Ø¦Ù„Ø©</div></div>
                                <div><button onClick={()=>startEdit(iss)} className="bg-yellow-100 text-yellow-700 px-3 py-1 rounded mx-1">ØªØ¹Ø¯ÙŠÙ„</button><button onClick={()=>deleteIssue(iss.id)} className="bg-red-100 text-red-700 px-3 py-1 rounded">Ø­Ø°Ù</button></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function CodesTab({ refreshIssues }) {
            const [issueId, setIssueId] = React.useState(''); const [count, setCount] = React.useState(''); const [loading, setLoading] = React.useState(false); const [codes, setCodes] = React.useState([]); const [issuesList, setIssuesList] = React.useState([]); const [codeType, setCodeType] = React.useState('unused');
            React.useEffect(() => { const f = async () => { const { data } = await supabase.from('issues').select('id, title'); if (data) setIssuesList(data); }; f(); }, [refreshIssues]);
            
            const fetchCodes = async () => { const used = codeType === 'used'; if (!issueId) return; const { data } = await supabase.from('codes').select('*').eq('issue_id', issueId).eq('used', used); setCodes(data || []); };
            const generate = async () => { setLoading(true); try { await generateCodesLogic(issueId, count); fetchCodes(); } catch(e){ alert(e.message); } finally { setLoading(false); } };
            const deleteCodes = async () => { if(!confirm('Ø­Ø°ÙØŸ')) return; await supabase.from('codes').delete().in('code', codes.map(c=>c.code)); setCodes([]); };
            
            const printCodes = () => {
                if(codes.length === 0) return;
                const w = window.open('', '_blank');
                w.document.write(`<html><head><style>body{font-family:sans-serif;text-align:center;direction:rtl;} .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;} .card{border:1px dashed #000;padding:5px;}</style></head><body><h1>Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¹Ø¯Ø¯ ${issueId}</h1><div class="grid">`);
                codes.forEach(c => w.document.write(`<div class="card"><div>#${c.issue_id}</div><img src="${generateQrDataUrl(c.code)}" width="100"><br><b>${c.code}</b></div>`));
                w.document.write('</div></body></html>'); w.document.close(); setTimeout(()=>w.print(), 500);
            };

            return (
                <div className="grid lg:grid-cols-2 gap-8 no-print animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow border-t-4 border-green-500 h-fit">
                        <h2 className="font-bold text-2xl mb-6">âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯</h2>
                        <input value={issueId} onChange={e=>setIssueId(e.target.value)} placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø¯" className="w-full p-4 border rounded-xl mb-4"/>
                        <input value={count} onChange={e=>setCount(e.target.value)} type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯" className="w-full p-4 border rounded-xl mb-4"/>
                        <button onClick={generate} disabled={loading} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold">{loading?'...':'ØªÙˆÙ„ÙŠØ¯'}</button>
                    </div>
                    <div className="bg-white p-8 rounded-2xl shadow border-t-4 border-purple-500">
                        <h2 className="font-bold text-2xl mb-6">ğŸ–¨ï¸ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h2>
                        <div className="flex gap-2 mb-4 bg-gray-100 p-1 rounded"><button onClick={()=>{setCodeType('unused');fetchCodes();}} className={`flex-1 py-2 ${codeType==='unused'?'bg-white shadow':''}`}>Ø¬Ø¯ÙŠØ¯Ø©</button><button onClick={()=>{setCodeType('used');fetchCodes();}} className={`flex-1 py-2 ${codeType==='used'?'bg-white shadow':''}`}>Ù…Ø³ØªØ®Ø¯Ù…Ø©</button></div>
                        <select value={issueId} onChange={e=>setIssueId(e.target.value)} onBlur={fetchCodes} className="w-full p-3 border rounded-xl mb-4"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø¯Ø¯...</option>{issuesList.map(i=><option key={i.id} value={i.id}>#{i.id} - {i.title.ar}</option>)}</select>
                        <button onClick={fetchCodes} className="w-full bg-gray-800 text-white px-6 py-2 rounded-xl mb-4">Ø¹Ø±Ø¶ ({codes.length})</button>
                        <div className="grid grid-cols-2 gap-3"><button onClick={printCodes} className="bg-purple-600 text-white py-3 rounded-xl font-bold">Ø·Ø¨Ø§Ø¹Ø©</button><button onClick={deleteCodes} className="bg-red-600 text-white py-3 rounded-xl font-bold">Ø­Ø°Ù</button></div>
                    </div>
                </div>
            );
        }

        function SettingsTab({ config, refresh }) {
            const [data, setData] = React.useState(config);
            const [bgFile, setBgFile] = React.useState(null);
            const [logoFile, setLogoFile] = React.useState(null); 
            const [keys, setKeys] = React.useState(config.gemini_keys_list || []);
            const [loading, setLoading] = React.useState(false);

            React.useEffect(() => { setData(config); setKeys(config.gemini_keys_list || []); }, [config]);

            const save = async () => {
                setLoading(true);
                try {
                    let bg = data.appBackground, logo = data.appLogo;
                    if(bgFile) bg = await uploadFile(bgFile);
                    if(logoFile) logo = await uploadFile(logoFile);
                    const newVal = { ...data, appBackground: bg, appLogo: logo, gemini_keys_list: keys };
                    await supabase.from('settings').upsert({key:'config', value: newVal});
                    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); refresh();
                } catch(e) { alert(e.message); } finally { setLoading(false); }
            };

            return (
                <div className="max-w-4xl mx-auto bg-white p-8 rounded-3xl shadow-xl border-t-4 border-blue-600 animate-fade-in">
                    <h2 className="font-bold text-2xl mb-6">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
                    <div className="bg-red-50 p-6 rounded-xl border border-red-200 mb-6">
                        <h3 className="font-bold text-red-800 mb-2">Ù…ÙØ§ØªÙŠØ­ AI (Gemini)</h3>
                        {keys.map((k, i) => (
                            <div key={i} className="flex gap-2 mb-2">
                                <input value={k.key} onChange={e => {const n=[...keys];n[i].key=e.target.value;setKeys(n)}} placeholder="Key" className="flex-1 p-2 border rounded"/>
                                <button onClick={() => setKeys(keys.filter((_, idx) => idx !== i))} className="text-red-600">ğŸ—‘ï¸</button>
                            </div>
                        ))}
                        <button onClick={() => setKeys([...keys, { key: '', expires: '' }])} className="text-red-600 font-bold">+ Ù…ÙØªØ§Ø­</button>
                    </div>
                    <div className="grid md:grid-cols-2 gap-4 mb-4">
                        <div><label className="block font-bold">ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</label><input type="file" onChange={e=>setBgFile(e.target.files[0])} className="w-full border p-2"/></div>
                        <div><label className="block font-bold">Ø§Ù„Ù„ÙˆØ¬Ùˆ</label><input type="file" onChange={e=>setLogoFile(e.target.files[0])} className="w-full border p-2"/></div>
                        <div><label className="block font-bold">ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù†</label><input value={data.adminPassword} onChange={e=>setData({...data,adminPassword:e.target.value})} className="w-full border p-2"/></div>
                        <div><label className="block font-bold">Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</label><input value={data.internalPassword} onChange={e=>setData({...data,internalPassword:e.target.value})} className="w-full border p-2"/></div>
                    </div>
                    <div className="bg-gray-50 p-4 rounded border mb-4">
                        <label className="block font-bold mb-2">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨</label>
                        <input value={data.introTitle} onChange={e=>setData({...data,introTitle:e.target.value})} className="w-full border p-2 mb-2" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"/>
                        <textarea value={data.introBody} onChange={e=>setData({...data,introBody:e.target.value})} className="w-full border p-2 h-20" placeholder="Ø§Ù„Ù…Ø­ØªÙˆÙ‰"/>
                    </div>
                    <button onClick={save} disabled={loading} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">{loading?'...':'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª'}</button>
                </div>
            );
        }

        function App() {
            const [tab, setTab] = React.useState('overview');
            const [auth, setAuth] = React.useState(sessionStorage.getItem('admin')==='true');
            const [config, setConfig] = React.useState({});
            const [issues, setIssues] = React.useState([]);
            const [toggle, setToggle] = React.useState(false);
            const [isInternalUnlocked, setIsInternalUnlocked] = React.useState(sessionStorage.getItem('internal_lock') === 'unlocked');

            React.useEffect(() => {
                const init = async () => {
                    const { data: s } = await supabase.from('settings').select('value').eq('key', 'config').maybeSingle();
                    if(s) { setConfig(s.value); adminPassword = s.value.adminPassword || "123"; internalPassword = s.value.internalPassword || "456"; }
                    const { data: i } = await supabase.from('issues').select('*').order('created_at', {ascending:false}); 
                    setIssues(i || []);
                };
                init();
            }, [toggle]);

            if(!auth) return <LoginView onLogin={(v)=>{if(v){sessionStorage.setItem('admin','true'); setAuth(true);}}}/>;

            const handleInternalUnlock = () => { setIsInternalUnlocked(true); sessionStorage.setItem('internal_lock', 'unlocked'); };

            const renderContent = () => {
                if (tab === 'overview') return <OverviewTab refresh={toggle} />; 
                const sensitiveTabs = ['issues', 'codes', 'settings', 'contest_results', 'riddles_leaderboard'];
                if (sensitiveTabs.includes(tab) && config.enableInternalLock && !isInternalUnlocked) {
                    return <InternalLockView onUnlock={handleInternalUnlock} />;
                }
                switch (tab) {
                    case 'issues': return <IssuesTab issues={issues} refresh={()=>setToggle(!toggle)} />;
                    case 'codes': return <CodesTab refreshIssues={toggle} />;
                    case 'contest_results': return <ContestResultsTab issues={issues} refresh={toggle} />; // Pass issues list
                    case 'riddles_leaderboard': return <RiddlesLeaderboardTab refresh={toggle} />;
                    case 'settings': return <SettingsTab config={config} refresh={()=>setToggle(!toggle)} />;
                    default: return <OverviewTab refresh={toggle} />;
                }
            };

            return (
                <div className="max-w-6xl mx-auto">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-xl shadow">
                        <h1 className="font-bold text-xl text-blue-800 mb-4 md:mb-0">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… BeØ¬ÙˆØ±ÙŠ</h1>
                        <div className="flex flex-wrap gap-2 justify-center">
                            <button onClick={()=>setTab('overview')} className={`px-3 py-2 rounded ${tab==='overview'?'bg-blue-600 text-white':'bg-gray-100'}`}>ğŸ¤ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
                            <button onClick={()=>setTab('contest_results')} className={`px-3 py-2 rounded ${tab==='contest_results'?'bg-purple-600 text-white':'bg-gray-100'}`}>ğŸ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
                            <button onClick={()=>setTab('riddles_leaderboard')} className={`px-3 py-2 rounded ${tab==='riddles_leaderboard'?'bg-yellow-600 text-white':'bg-gray-100'}`}>ğŸ¥‡ Ø´Ø±Ù Ø§Ù„ÙÙˆØ§Ø²ÙŠØ±</button>
                            <button onClick={()=>setTab('issues')} className={`px-3 py-2 rounded ${tab==='issues'?'bg-blue-600 text-white':'bg-gray-100'}`}>ğŸ“° Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯</button>
                            <button onClick={()=>setTab('codes')} className={`px-3 py-2 rounded ${tab==='codes'?'bg-blue-600 text-white':'bg-gray-100'}`}>ğŸ« Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</button>
                            <button onClick={()=>setTab('settings')} className={`px-3 py-2 rounded ${tab==='settings'?'bg-blue-600 text-white':'bg-gray-100'}`}>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                            <button onClick={()=>{sessionStorage.clear();setAuth(false);setIsInternalUnlocked(false);}} className="bg-red-50 text-red-600 px-3 py-2 rounded border border-red-200">Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </div>
                    {renderContent()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>