<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… BeØ¬ÙˆØ±ÙŠ - Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- âœ… Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo'; background-color: #f3f4f6; }
        .tab-btn { transition: all 0.3s; }
        .tab-btn.active { background-color: #2563eb; color: white; transform: scale(1.05); }
        .tab-btn.disabled { opacity: 0.6; cursor: not-allowed; background: #e5e7eb; color: #9ca3af; }
        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        @media print { .no-print { display: none !important; } .qr-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; } .qr-card { border: 2px dashed #000; padding: 10px; text-align: center; } #printContainer { display: block !important; } }
    </style>
</head>
<body class="p-4 md:p-8 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        // âœ… Ø¨ÙŠØ§Ù†Ø§Øª Supabase (Service Role)
        const SUPABASE_URL = "https://ozdnyepxfcjzldpkteau.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96ZG55ZXB4ZmNqemxkcGt0ZWF1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NDEwNTM3MiwiZXhwIjoyMDc5NjgxMzcyfQ.mtqFcdRZeidpC0Ul8r_8FJOJalToT4lZeHNqd3-fsOg";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let adminPassword = "123";
        let internalPassword = "456";
        let currentCodeType = 'unused';
        let fetchedCodes = [];
        const BACKUP_PASSWORDS = ["Admin@2025", "BeJouri#Hero", "Jesus#Love"];

        // (Helper functions: compressImage, uploadFile, generateCodesLogic, LoginView, InternalLockView - Remain SAME)
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const maxWidth = 1000; let width = img.width; let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => { resolve(new File([blob], file.name, { type: 'image/jpeg' })); }, 'image/jpeg', 0.7);
                    };
                };
            });
        }

        async function uploadFile(file) {
            if (!file) return null;
            const compressed = await compressImage(file);
            const fileName = `${Date.now()}_${file.name}`;
            const { data, error } = await supabase.storage.from('images').upload(fileName, compressed);
            if (error) throw error;
            const { data: urlData } = supabase.storage.from('images').getPublicUrl(fileName);
            return urlData.publicUrl;
        }

        async function generateCodesLogic(issueId, count) {
            if (!issueId || !count) throw new Error("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø¯ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯.");
            const codes = [];
            for (let i = 0; i < count; i++) {
                codes.push({ code: `BJ-${issueId}-${Math.floor(10000 + Math.random() * 90000)}`, issue_id: issueId });
            }
            const { error } = await supabase.from('codes').insert(codes);
            if (error) throw error;
            return codes.length;
        }
        
        function LoginView({ onLogin }) {
            const [pass, setPass] = React.useState('');
            const handleLogin = () => { if (pass === adminPassword || BACKUP_PASSWORDS.includes(pass)) onLogin(true); else alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø© âŒ'); };
            return (<div className="h-screen flex items-center justify-center bg-gray-100"><div className="bg-white p-8 rounded-2xl shadow-xl w-96 text-center border-t-4 border-blue-600"><h2 className="text-3xl font-bold mb-6 text-gray-800">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h2><input type="password" value={pass} onChange={e => setPass(e.target.value)} onKeyDown={e => {if (e.key === 'Enter') handleLogin()}} className="w-full p-4 border-2 border-gray-200 rounded-xl mb-4 outline-none" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"/><button onClick={handleLogin} className="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-3 rounded-xl w-full transition">Ø¯Ø®ÙˆÙ„</button></div></div>);
        }

        function InternalLockView({ onUnlock }) {
            const [pass, setPass] = React.useState('');
            const checkPass = () => { if (pass === internalPassword || BACKUP_PASSWORDS.includes(pass)) onUnlock(); else { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø© ğŸ”’'); setPass(''); } };
            return (<div className="flex flex-col items-center justify-center h-full p-10 text-center animate-fade-in"><div className="bg-white p-10 rounded-3xl shadow-2xl border border-red-100 max-w-md w-full"><div className="text-6xl mb-4">ğŸ›¡ï¸</div><h2 className="text-2xl font-black text-gray-800 mb-2">Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ù…ÙŠØ©</h2><p className="text-gray-500 mb-6 text-sm">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„ÙˆØµÙˆÙ„</p><input type="password" value={pass} onChange={e => setPass(e.target.value)} onKeyDown={e => {if (e.key === 'Enter') checkPass()}} className="w-full p-4 bg-gray-50 border-2 border-gray-200 rounded-xl mb-4 text-center text-lg font-bold tracking-widest focus:border-red-400 outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/><button onClick={checkPass} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-105">ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ ğŸ”“</button></div></div>);
        }

        // --- âœ… ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù…Ø¹Ø¯Ù„ Ù„Ù„Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
        function OverviewTab({ config }) {
            const [activeUsers, setActiveUsers] = React.useState(0);
            const [children, setChildren] = React.useState([]);
            const [gradeFilter, setGradeFilter] = React.useState("all");
            
            const showChildrenDB = config?.enableChildLogin;

            React.useEffect(() => {
                const fetchCount = async () => {
                    const twentyMinsAgo = new Date(Date.now() - 20 * 60 * 1000).toISOString();
                    const { count, error } = await supabase.from('online_users').select('*', { count: 'exact', head: true }).gt('last_seen', twentyMinsAgo);
                    if (!error) setActiveUsers(count || 0);
                };
                fetchCount();
                const interval = setInterval(fetchCount, 30000);
                return () => clearInterval(interval);
            }, []);

            React.useEffect(() => {
                if (!showChildrenDB) return; 
                const fetchChildren = async () => {
                    const { data } = await supabase.from('children').select('*').order('points', { ascending: false });
                    if (data) setChildren(data);
                };
                fetchChildren();
            }, [showChildrenDB]);

            const filteredChildren = gradeFilter === "all" ? children : children.filter(c => c.grade === gradeFilter);

            const printChildren = () => {
                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¬ÙˆØ±ÙŠ</title><style>body{font-family:sans-serif; direction:rtl;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #000; padding:8px; text-align:center;} </style></head><body>');
                printWindow.document.write(`<h1>Ù‚Ø§Ø¦Ù…Ø© Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¬ÙˆØ±ÙŠ: ${gradeFilter === 'all' ? 'Ø§Ù„ÙƒÙ„' : gradeFilter}</h1>`);
                printWindow.document.write('<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead><tbody>');
                filteredChildren.forEach(c => {
                    printWindow.document.write(`<tr><td>${c.full_name}</td><td>${c.phone}</td><td>${c.parent_phone}</td><td>${c.points}</td></tr>`);
                });
                printWindow.document.write('</tbody></table></body></html>');
                printWindow.document.close();
                printWindow.print();
            };

            return (
                <div className="space-y-8 animate-fade-in">
                    <div className={`grid ${showChildrenDB ? 'md:grid-cols-2' : 'md:grid-cols-1'} gap-6 no-print`}>
                        {/* ÙƒØ§Ø±Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† */}
                        <div className="bg-gradient-to-br from-indigo-600 to-blue-500 rounded-3xl p-8 text-white shadow-2xl relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-full bg-white/10 transform -skew-y-12"></div>
                            <div className="relative z-10">
                                <div className="flex items-center gap-3 mb-4"><div className="w-3 h-3 bg-green-400 rounded-full animate-pulse shadow-[0_0_10px_#4ade80]"></div><h3 className="text-lg font-bold opacity-90">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† (Live)</h3></div>
                                <div className="text-6xl font-black mb-2 tracking-tight">{activeUsers}</div>
                                <p className="text-sm opacity-75">Ø¬ÙˆØ±ÙŠ Ù…ØªÙˆØ§Ø¬Ø¯ Ø§Ù„Ø¢Ù† (Ø¢Ø®Ø± 20 Ø¯Ù‚ÙŠÙ‚Ø©)</p>
                            </div>
                        </div>

                        {/* ÙƒØ§Ø±Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„) */}
                        {showChildrenDB && (
                            <div className="bg-white rounded-3xl p-8 shadow-lg border border-gray-100 flex flex-col justify-center items-center text-center animate-pop-in">
                                <div className="text-5xl mb-4">ğŸ“</div>
                                <h3 className="text-2xl font-bold text-gray-800 mb-2">Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬ÙˆØ±ÙŠ</h3>
                                <div className="text-4xl font-black text-indigo-600">{children.length}</div>
                                <p className="text-gray-500">Ø¬ÙˆØ±ÙŠ Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</p>
                            </div>
                        )}
                    </div>

                    {/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„) */}
                    {showChildrenDB && (
                        <div className="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-orange-500 animate-fade-in">
                            <div className="flex flex-wrap justify-between items-center mb-6 gap-4 no-print">
                                <h3 className="text-xl font-bold text-gray-800">ğŸ“‹ Ø³Ø¬Ù„ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¬ÙˆØ±ÙŠ</h3>
                                <div className="flex gap-2">
                                    <select value={gradeFilter} onChange={e=>setGradeFilter(e.target.value)} className="p-2 border rounded-xl bg-gray-50 font-bold">
                                        <option value="all">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>
                                        <option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                        <option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    </select>
                                    <button onClick={printChildren} className="bg-gray-800 text-white px-4 py-2 rounded-xl font-bold hover:bg-black transition">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                                </div>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-right">
                                    <thead className="bg-gray-100 text-gray-600 uppercase font-bold">
                                        <tr><th className="p-4 rounded-r-xl">Ø§Ù„Ø§Ø³Ù…</th><th className="p-4">Ø§Ù„ØµÙ</th><th className="p-4">Ø§Ù„Ù‡Ø§ØªÙ</th><th className="p-4">ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th><th className="p-4 rounded-l-xl">Ø§Ù„Ù†Ù‚Ø§Ø· â­</th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {filteredChildren.map(child => (
                                            <tr key={child.id} className="hover:bg-gray-50">
                                                <td className="p-4 font-bold text-gray-800">{child.full_name}</td>
                                                <td className="p-4 text-gray-500">{child.grade}</td>
                                                <td className="p-4 font-mono">{child.phone}</td>
                                                <td className="p-4 font-mono">{child.parent_phone}</td>
                                                <td className="p-4 font-bold text-orange-600">{child.points}</td>
                                            </tr>
                                        ))}
                                        {filteredChildren.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
        function IssuesTab({ issues, refresh }) {
            const [issueData, setIssueData] = React.useState({ id: '', title: '', date: '', magUrl: '', verseText: '', verseRef: '', isFree: false, file: null, videos: [{ title: '', url: '' }] });
            const [loading, setLoading] = React.useState(false);
            const [editingId, setEditingId] = React.useState(null);
            const handleAddVideo = () => setIssueData(p => ({ ...p, videos: [...p.videos, { title: '', url: '' }] }));
            const handleVideoChange = (index, field, value) => { const newVideos = [...issueData.videos]; newVideos[index][field] = value; setIssueData(p => ({ ...p, videos: newVideos })); };
            const startEdit = (issue) => { setEditingId(issue.id); setIssueData({ id: issue.id, title: issue.title.ar, date: issue.date.ar, magUrl: issue.magazine_url, verseText: issue.verse?.text || '', verseRef: issue.verse?.ref || '', isFree: issue.is_free, file: null, videos: issue.videos || [{ title: '', url: '' }] }); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const cancelEdit = () => { setEditingId(null); setIssueData({ id: '', title: '', date: '', magUrl: '', verseText: '', verseRef: '', isFree: false, file: null, videos: [{ title: '', url: '' }] }); };
            const saveIssue = async () => { setLoading(true); try { if (!issueData.id || !issueData.title) throw new Error("Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø¯ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†"); let bgUrl = issueData.file ? await uploadFile(issueData.file) : null; const issuePayload = { title: { ar: issueData.title }, date: { ar: issueData.date }, magazine_url: issueData.magUrl, is_free: issueData.isFree, verse: { text: issueData.verseText, ref: issueData.verseRef }, videos: issueData.videos.filter(v => v.title && v.url) }; if (bgUrl) issuePayload.background = bgUrl; let error; if (editingId) { const { error: updateError } = await supabase.from('issues').update(issuePayload).eq('id', editingId); error = updateError; } else { issuePayload.id = issueData.id; if (!bgUrl && !editingId) issuePayload.background = ""; const { error: insertError } = await supabase.from('issues').insert([issuePayload]); error = insertError; } if (error) throw error; alert(editingId ? 'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! âœ…' : 'ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­! âœ…'); cancelEdit(); refresh(); } catch (e) { alert('Ø®Ø·Ø£: ' + e.message); } finally { setLoading(false); } };
            const deleteIssue = async (id) => { if(confirm(`Ø­Ø°Ù Ø§Ù„Ø¹Ø¯Ø¯ #${id}ØŸ`)) { const { error } = await supabase.from('issues').delete().eq('id', id); if (error) alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + error.message); else refresh(); } };
            return (<div className="grid lg:grid-cols-3 gap-8 animate-fade-in"><div className="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg border-t-4 border-blue-600 h-fit"><h2 className="font-bold text-xl mb-4 text-blue-800">{editingId ? `âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ #${editingId}` : 'â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ Ø¬Ø¯ÙŠØ¯'}</h2><div className="space-y-4"><input value={issueData.id} onChange={e => setIssueData(p => ({ ...p, id: e.target.value }))} type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø¯ (ID)" disabled={!!editingId} className={`w-full p-3 border rounded-xl bg-gray-50 ${editingId ? 'opacity-50 cursor-not-allowed' : ''}`}/><input value={issueData.title} onChange={e => setIssueData(p => ({ ...p, title: e.target.value }))} placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" className="w-full p-3 border rounded-xl bg-gray-50"/><input value={issueData.date} onChange={e => setIssueData(p => ({ ...p, date: e.target.value }))} placeholder="Ø§Ù„ØªØ§Ø±ÙŠØ®" className="w-full p-3 border rounded-xl bg-gray-50"/><input value={issueData.magUrl} onChange={e => setIssueData(p => ({ ...p, magUrl: e.target.value }))} placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¬Ù„Ø© (FlipHTML5)" className="w-full p-3 border rounded-xl bg-gray-50"/><div className="bg-yellow-50 p-3 rounded-xl border border-yellow-200"><input value={issueData.verseText} onChange={e => setIssueData(p => ({ ...p, verseText: e.target.value }))} placeholder="Ø§Ù„Ø¢ÙŠØ©" className="w-full mb-2 p-2 rounded border"/><input value={issueData.verseRef} onChange={e => setIssueData(p => ({ ...p, verseRef: e.target.value }))} placeholder="Ø§Ù„Ø´Ø§Ù‡Ø¯" className="w-full p-2 rounded border"/></div><div className="border-t pt-3"><label className="block text-sm font-bold mb-2">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø¹Ø¯Ø¯ (Ø®Ø§ØµØ©):</label><div className="space-y-2">{issueData.videos.map((video, index) => (<div key={index} className="flex gap-2 video-row"><input value={video.title} onChange={e => handleVideoChange(index, 'title', e.target.value)} placeholder="Ø¹Ù†ÙˆØ§Ù†" className="w-1/2 p-2 border rounded text-sm"/><input value={video.url} onChange={e => handleVideoChange(index, 'url', e.target.value)} placeholder="Ø±Ø§Ø¨Ø·" className="w-1/2 p-2 border rounded text-sm"/></div>))}</div><button onClick={handleAddVideo} className="text-blue-600 text-sm font-bold mt-2 hover:underline">+ ÙÙŠØ¯ÙŠÙˆ Ø¢Ø®Ø±</button></div><div><label className="block text-sm font-bold mb-1">ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù:</label><input type="file" onChange={e => setIssueData(p => ({ ...p, file: e.target.files[0] }))} className="w-full text-sm p-2 border rounded-xl bg-gray-50"/></div><div className="bg-green-50 p-3 rounded-xl flex items-center gap-2"><input type="checkbox" checked={issueData.isFree} onChange={e => setIssueData(p => ({ ...p, isFree: e.target.checked }))} className="w-5 h-5"/><label className="font-bold text-sm text-green-800">ğŸ”“ Ø¹Ø¯Ø¯ Ù…Ø¬Ø§Ù†ÙŠ</label></div><div className="flex gap-2"><button onClick={saveIssue} disabled={loading} className={`flex-1 text-white py-3 rounded-xl font-bold shadow-lg transition ${editingId ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-600 hover:bg-blue-700'}`}>{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : (editingId ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ğŸ’¾' : 'Ù†Ø´Ø± Ø§Ù„Ø¹Ø¯Ø¯ ğŸš€')}</button>{editingId && (<button onClick={cancelEdit} className="px-4 py-3 bg-gray-300 rounded-xl font-bold hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>)}</div></div></div><div className="lg:col-span-2 space-y-4"><h2 className="font-bold text-2xl mb-4 text-gray-800">ğŸ“š Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© ({issues.length})</h2>{issues.map(i => (<div key={i.id} className={`bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center border-r-8 hover:shadow-md transition ${i.is_free ? 'border-green-500' : 'border-blue-500'}`}><div><div className="font-bold text-lg text-gray-800">#{i.id} - {i.title.ar} {i.is_free ? 'ğŸ' : 'ğŸ”’'}</div><div className="text-sm text-gray-500">{i.date.ar}</div></div><div className="flex gap-2"><button onClick={() => startEdit(i)} className="bg-yellow-50 text-yellow-600 px-4 py-2 rounded-lg font-bold border border-yellow-200 hover:bg-yellow-500 hover:text-white transition">ØªØ¹Ø¯ÙŠÙ„ âœï¸</button><button onClick={() => deleteIssue(i.id)} className="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold border border-red-200 hover:bg-red-600 hover:text-white transition">Ø­Ø°Ù</button></div></div>))}</div></div>);
        }

        function AmazingBookTab() {
            const [videos, setVideos] = React.useState([]); const [newVideo, setNewVideo] = React.useState({ title_ar: '', url: '' }); const [loading, setLoading] = React.useState(false);
            const fetchVideos = React.useCallback(async () => { const { data } = await supabase.from('amazing_book_videos').select('*').order('created_at', { ascending: false }); setVideos(data || []); }, []);
            React.useEffect(() => { fetchVideos(); }, [fetchVideos]);
            const saveVideo = async () => { setLoading(true); try { if (!newVideo.title_ar || !newVideo.url) throw new Error("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø§Ø¨Ø·."); const { error } = await supabase.from('amazing_book_videos').insert([newVideo]); if (error) throw error; alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­! âœ…'); setNewVideo({ title_ar: '', url: '' }); fetchVideos(); } catch (e) { alert('Ø®Ø·Ø£: ' + e.message); } finally { setLoading(false); } };
            const deleteVideo = async (id, title) => { if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙÙŠØ¯ÙŠÙˆ "${title}"ØŸ`)) { const { error } = await supabase.from('amazing_book_videos').delete().eq('id', id); if (error) alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + error.message); else fetchVideos(); } };
            return (<div className="grid lg:grid-cols-3 gap-8 animate-fade-in"><div className="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg border-t-4 border-green-600 h-fit"><h2 className="font-bold text-xl mb-4 text-green-800">â• Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯</h2><div className="space-y-4"><input value={newVideo.title_ar} onChange={e => setNewVideo(p => ({ ...p, title_ar: e.target.value }))} placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ" className="w-full p-3 border rounded-xl bg-gray-50"/><input value={newVideo.url} onChange={e => setNewVideo(p => ({ ...p, url: e.target.value }))} placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (URL)" className="w-full p-3 border rounded-xl bg-gray-50"/><button onClick={saveVideo} disabled={loading} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg transition">{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ğŸ’¾'}</button></div></div><div className="lg:col-span-2 space-y-4"><h2 className="font-bold text-2xl mb-4 text-gray-800">ğŸ¬ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ({videos.length})</h2>{videos.map(v => (<div key={v.id} className="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center border-r-8 border-green-500 hover:shadow-md transition"><div><div className="font-bold text-lg text-gray-800">{v.title_ar}</div><div className="text-sm text-gray-500 truncate w-96">{v.url}</div></div><button onClick={() => deleteVideo(v.id, v.title_ar)} className="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold border border-red-200 hover:bg-red-600 hover:text-white transition">Ø­Ø°Ù</button></div>))}</div></div>);
        }

        function CodesTab({ refreshIssues }) {
            const [issueId, setIssueId] = React.useState(''); const [count, setCount] = React.useState(''); const [loading, setLoading] = React.useState(false); const [codes, setCodes] = React.useState([]); const [issuesList, setIssuesList] = React.useState([]);
            React.useEffect(() => { const fetchList = async () => { const { data } = await supabase.from('issues').select('id, title'); if (data) setIssuesList(data); }; fetchList(); }, [refreshIssues]);
            const fetchCodesPreview = async () => { const used = currentCodeType === 'used'; if (!issueId) return; const { data } = await supabase.from('codes').select('*').eq('issue_id', issueId).eq('used', used); fetchedCodes = data || []; setCodes(fetchedCodes); };
            const generateCodes = async () => { setLoading(true); try { const generatedCount = await generateCodesLogic(issueId, count); alert(`ØªÙ… ØªÙˆÙ„ÙŠØ¯ ${generatedCount} ÙƒÙˆØ¯!`); fetchCodesPreview(); } catch(e) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯: ' + e.message); } finally { setLoading(false); } };
            const deleteDisplayedCodes = async () => { if (codes.length === 0 || !confirm(`Ø­Ø°Ù ${codes.length} ÙƒÙˆØ¯ØŸ`)) return; const codesToDelete = codes.map(c => c.code); const { error } = await supabase.from('codes').delete().in('code', codesToDelete); if (error) alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + error.message); else { alert("ØªÙ… Ø§Ù„Ø­Ø°Ù!"); setCodes([]); } };
            const switchView = (type) => { currentCodeType = type; fetchCodesPreview(); };
            const printCurrentView = () => { if(codes.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯!"); const printDiv = document.createElement('div'); printDiv.style.display = 'grid'; printDiv.style.gridTemplateColumns = 'repeat(4, 1fr)'; printDiv.style.gap = '15px'; codes.forEach(c => { const card = document.createElement('div'); card.className = 'qr-card'; card.innerHTML = `<div class="font-bold text-xs mb-1">BeØ¬ÙˆØ±ÙŠ #${c.issue_id}</div><canvas id="qr-${c.code}"></canvas><div class="font-mono text-xs mt-1 font-bold">${c.code}</div>`; printDiv.appendChild(card); }); document.body.appendChild(printDiv); codes.forEach(c => new QRious({ element: document.getElementById(`qr-${c.code}`), value: c.code, size: 100 })); window.print(); document.body.removeChild(printDiv); };
            return (<div className="grid lg:grid-cols-2 gap-8 no-print animate-fade-in"><div className="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-green-500 h-fit"><h2 className="font-bold text-2xl mb-6 text-gray-800">âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯</h2><input value={issueId} onChange={e => setIssueId(e.target.value)} placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø¯" className="w-full p-4 border rounded-xl mb-4 text-lg"/><input value={count} onChange={e => setCount(e.target.value)} type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯" className="w-full p-4 border rounded-xl mb-4 text-lg"/><button onClick={generateCodes} disabled={loading} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg transition">{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...' : 'ØªÙˆÙ„ÙŠØ¯ ÙˆØ­ÙØ¸ ğŸ’¾'}</button></div><div className="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-purple-500"><h2 className="font-bold text-2xl mb-6 text-gray-800">ğŸ–¨ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h2><div className="flex gap-2 mb-4 bg-gray-100 p-1.5 rounded-xl"><button onClick={() => switchView('unused')} className={`flex-1 py-3 rounded-lg font-bold text-sm ${currentCodeType === 'unused' ? 'active bg-purple-600' : 'bg-gray-100 text-gray-600'}`}>Ø¬Ø¯ÙŠØ¯Ø©</button><button onClick={() => switchView('used')} className={`flex-1 py-3 rounded-lg font-bold text-sm ${currentCodeType === 'used' ? 'active bg-purple-600' : 'bg-gray-100 text-gray-600'}`}>Ù…Ø³ØªØ®Ø¯Ù…Ø©</button></div><select value={issueId} onChange={e => setIssueId(e.target.value)} onBlur={fetchCodesPreview} className="w-full p-3 border rounded-xl mb-4"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø¯Ø¯...</option>{issuesList.map(i => <option key={i.id} value={i.id}>#{i.id} - {i.title.ar}</option>)}</select><button onClick={fetchCodesPreview} className="w-full bg-gray-800 text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition mb-4">Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</button><div className="bg-gray-50 p-4 rounded-xl border mb-4"><div className="flex justify-between mb-2"><span className="font-bold">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:</span><span className="bg-blue-100 px-3 py-1 rounded-full font-bold">{codes.length} ÙƒÙˆØ¯</span></div><div className="h-32 overflow-y-auto text-xs font-mono bg-white p-3 rounded-lg border text-gray-500 leading-relaxed">{codes.length > 0 ? codes.map(c => c.code).join(', ') : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù„Ø¹Ø±Ø¶Ù‡Ø§.'}</div></div><div className="grid grid-cols-2 gap-3"><button onClick={printCurrentView} className="bg-purple-600 text-white py-3 rounded-xl font-bold shadow">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button onClick={deleteDisplayedCodes} disabled={codes.length === 0} className={`py-3 rounded-xl font-bold transition ${codes.length === 0 ? 'bg-red-100 text-red-400 cursor-not-allowed' : 'bg-red-600 text-white shadow-lg hover:bg-red-700'}`}>ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button></div></div></div>);
        }

        // --- âœ… ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø« (Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø¹Ø¯Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ) ---
        function SettingsTab({ config, refresh }) {
            const [data, setData] = React.useState(config);
            const [loading, setLoading] = React.useState(false);

            // âœ… Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¶Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±Ù… Ø¨Ù…Ø¬Ø±Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            React.useEffect(() => { setData(config); }, [config]);

            const saveConf = async () => {
                setLoading(true);
                try {
                    let bgUrl = data.bgFile ? await uploadFile(data.bgFile) : data.appBackground;
                    let logoUrl = data.logoFile ? await uploadFile(data.logoFile) : data.appLogo;

                    const newVal = {
                        adminPassword: data.adminPassword,
                        internalPassword: data.internalPassword,
                        appBackground: bgUrl,
                        appLogo: logoUrl,
                        introTitle: data.introTitle,
                        introBody: data.introBody,
                        // âœ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… ÙƒÙ€ Boolean
                        enableChildLogin: !!data.enableChildLogin,
                        enableInternalLock: !!data.enableInternalLock 
                    };

                    const { error } = await supabase.from('settings').upsert({ key: 'config', value: newVal });
                    if (error) throw error;
                    
                    adminPassword = newVal.adminPassword; internalPassword = newVal.internalPassword;
                    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…'); refresh();
                } catch(e) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + e.message); } finally { setLoading(false); }
            };
            
            return (
                <div className="max-w-2xl mx-auto bg-white p-8 rounded-3xl shadow-xl border-t-4 border-blue-600 animate-fade-in">
                    <h2 className="font-bold text-2xl mb-6 border-b pb-4 text-gray-800">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
                    
                    <div className="bg-yellow-50 p-6 rounded-xl border border-yellow-200 mb-6 space-y-4">
                        <h3 className="font-bold text-yellow-800 mb-4 flex items-center gap-2"><span className="text-2xl">ğŸš€</span> Ù…ÙŠØ²Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
                        
                        {/* ØªÙØ¹ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¬ÙˆØ±ÙŠ */}
                        <div className="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm">
                            <div>
                                <div className="font-bold text-gray-800">ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø¬ÙˆØ±ÙŠ</div>
                                <div className="text-xs text-gray-500">ÙŠØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
                            </div>
                            <label className="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" checked={data.enableChildLogin || false} onChange={e => setData(p => ({ ...p, enableChildLogin: e.target.checked }))} className="sr-only peer" />
                                <div className="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        {/* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */}
                        <div className="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm">
                            <div>
                                <div className="font-bold text-gray-800">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (Double Security)</div>
                                <div className="text-xs text-gray-500">Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ø¨Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø¥Ø¶Ø§ÙÙŠ</div>
                            </div>
                            <label className="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" checked={data.enableInternalLock || false} onChange={e => setData(p => ({ ...p, enableInternalLock: e.target.checked }))} className="sr-only peer" />
                                <div className="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-red-600"></div>
                            </label>
                        </div>
                    </div>

                    <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6"><h3 className="font-bold text-indigo-800 mb-3">ğŸ‘‹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ©</h3><input value={data.introTitle} onChange={e => setData(p => ({ ...p, introTitle: e.target.value }))} placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" className="w-full p-3 border rounded-xl mb-3"/><textarea value={data.introBody} onChange={e => setData(p => ({ ...p, introBody: e.target.value }))} placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø©" className="w-full p-3 border rounded-xl h-24"/></div>
                    <div className="space-y-4"><div className="grid md:grid-cols-2 gap-4"><div><label className="block font-bold mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø§Ù„Ø¯Ø®ÙˆÙ„):</label><input value={data.adminPassword} onChange={e => setData(p => ({ ...p, adminPassword: e.target.value }))} className="w-full p-3 border rounded-xl bg-gray-50"/></div><div><label className="block font-bold mb-1 text-red-600">Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ:</label><input value={data.internalPassword} onChange={e => setData(p => ({ ...p, internalPassword: e.target.value }))} className="w-full p-3 border rounded-xl bg-red-50 border-red-200"/></div></div><div className="grid md:grid-cols-2 gap-4"><div><label className="block font-bold mb-1">ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©:</label><input type="file" onChange={e => setData(p => ({ ...p, bgFile: e.target.files[0] }))} className="w-full text-sm"/></div><div><label className="block font-bold mb-1">Ø§Ù„Ù„ÙˆØ¬Ùˆ:</label><input type="file" onChange={e => setData(p => ({ ...p, logoFile: e.target.files[0] }))} className="w-full text-sm"/></div></div></div><button onClick={saveConf} disabled={loading} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg mt-6 transition">{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª âœ…'}</button>
                </div>
            );
        }

        function App() {
            const [isAuth, setIsAuth] = React.useState(sessionStorage.getItem('admin') === 'true');
            const [isInternalUnlocked, setIsInternalUnlocked] = React.useState(false); 
            const [currentTab, setCurrentTab] = React.useState('overview'); 
            const [issues, setIssues] = React.useState([]);
            const [config, setConfig] = React.useState({});
            const [loading, setLoading] = React.useState(true);
            const [refreshToggle, setRefreshToggle] = React.useState(false);

            const fetchInitialData = React.useCallback(async () => {
                try {
                    const { data: settingsData } = await supabase.from('settings').select('value').eq('key', 'config').single();
                    if (settingsData) {
                        setConfig(settingsData.value);
                        adminPassword = settingsData.value.adminPassword;
                        internalPassword = settingsData.value.internalPassword || "456"; 
                    }
                    const { data: issuesData, error } = await supabase.from('issues').select('*').order('created_at', { ascending: false });
                    if (error) console.error("Fetch error:", error);
                    if (issuesData) setIssues(issuesData);
                } catch (e) { console.error("Error:", e); } finally { setLoading(false); }
            }, []);

            React.useEffect(() => { fetchInitialData(); }, [refreshToggle]);

            const handleLogin = (isSuccess) => { if (isSuccess) { sessionStorage.setItem('admin', 'true'); setIsAuth(true); } };
            const handleRefresh = () => setRefreshToggle(p => !p);

            if (loading) return <div className="h-screen flex items-center justify-center text-xl font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>;
            if (!isAuth) return <LoginView onLogin={handleLogin} />;

            const renderContent = () => {
                if (currentTab === 'overview') return <OverviewTab config={config} />; 
                
                if (config.enableInternalLock && !isInternalUnlocked) {
                    return <InternalLockView onUnlock={() => setIsInternalUnlocked(true)} />;
                }

                switch (currentTab) {
                    case 'issues': return <IssuesTab issues={issues} refresh={handleRefresh} />;
                    case 'codes': return <CodesTab refreshIssues={handleRefresh} />;
                    case 'amazing_book': return <AmazingBookTab />;
                    case 'settings': return <SettingsTab config={{...config, adminPassword, internalPassword}} refresh={handleRefresh} />;
                    default: return <OverviewTab config={config} />;
                }
            };

            return (
                <div className="max-w-7xl mx-auto">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 no-print bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <div className="flex items-center gap-3 mb-4 md:mb-0"><div className="bg-blue-600 text-white p-2 rounded-lg font-bold text-xl">Pro</div><h1 className="text-2xl font-bold text-gray-800">BeØ¬ÙˆØ±ÙŠ (Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)</h1></div>
                        <div className="flex flex-wrap gap-2 justify-center">
                            <button onClick={() => setCurrentTab('overview')} className={`tab-btn px-6 py-2 rounded-xl font-bold shadow-sm ${currentTab==='overview'?'active':'bg-gray-100 text-gray-600'}`}>ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
                            <button onClick={() => setCurrentTab('issues')} className={`tab-btn px-6 py-2 rounded-xl font-bold shadow-sm ${currentTab==='issues'?'active':'bg-gray-100 text-gray-600'} ${config.enableInternalLock && !isInternalUnlocked && currentTab !== 'overview' ? 'text-red-500' : ''}`}>ğŸ“° Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ {config.enableInternalLock ? 'ğŸ”’' : ''}</button>
                            <button onClick={() => setCurrentTab('codes')} className={`tab-btn px-6 py-2 rounded-xl font-bold shadow-sm ${currentTab==='codes'?'active':'bg-gray-100 text-gray-600'} ${config.enableInternalLock && !isInternalUnlocked && currentTab !== 'overview' ? 'text-red-500' : ''}`}>ğŸ« Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ {config.enableInternalLock ? 'ğŸ”’' : ''}</button>
                            <button onClick={() => setCurrentTab('amazing_book')} className={`tab-btn px-6 py-2 rounded-xl font-bold shadow-sm ${currentTab==='amazing_book'?'active':'bg-gray-100 text-gray-600'} ${config.enableInternalLock && !isInternalUnlocked && currentTab !== 'overview' ? 'text-red-500' : ''}`}>ğŸ“– Ø§Ù„ÙƒØªØ§Ø¨ {config.enableInternalLock ? 'ğŸ”’' : ''}</button>
                            <button onClick={() => setCurrentTab('settings')} className={`tab-btn px-6 py-2 rounded-xl font-bold shadow-sm ${currentTab==='settings'?'active':'bg-gray-100 text-gray-600'} ${config.enableInternalLock && !isInternalUnlocked && currentTab !== 'overview' ? 'text-red-500' : ''}`}>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª {config.enableInternalLock ? 'ğŸ”’' : ''}</button>
                            
                            <button onClick={() => { sessionStorage.clear(); setIsAuth(false); setIsInternalUnlocked(false); }} className="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-xl font-bold border border-red-200">Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </div>
                    <div id="contentArea">{renderContent()}</div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>