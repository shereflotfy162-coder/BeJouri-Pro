<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BeØ¬ÙˆØ±ÙŠ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4338ca">
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- âœ… Ù…ÙƒØªØ¨Ø© Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Cairo', 'sans-serif'], en: ['Fredoka', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)', 'pulsered': 'pulsered 1.5s infinite', 'bounce-slow': 'bounce 2s infinite' },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, 
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        float: { '0%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-10px)' }, '100%': { transform: 'translateY(0px)' } },
                        pulsered: { '0%, 100%': { backgroundColor: 'rgba(239, 68, 68, 1)' }, '50%': { backgroundColor: 'rgba(239, 68, 68, 0.5)' } } 
                    } 
                } 
            } 
        }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: 'Cairo', sans-serif; transition: background-color 0.3s; }
        .dark body { background-color: #0f172a; color: #e2e8f0; }
        .app-bg { position: fixed; inset: 0; z-index: -1; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; }
        .locked-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .verse-bubble { background-color: #fff; border-radius: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 2px solid #6366f1; animation: float 5s ease-in-out infinite; }
        .dark .verse-bubble { background-color: #1e293b; border-color: #4f46e5; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; animation: fall 3s linear infinite; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        .tear { position: absolute; width: 2px; height: 15px; background: #3b82f6; opacity: 0.7; animation: rain 1s linear infinite; }
        @keyframes rain { to { transform: translateY(100vh); } }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø­Ù‚ÙˆÙ„ */
        input, select, textarea, button { font-family: 'Cairo', sans-serif !important; }
        
        /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù… Ù„Ù„Ø­Ù‚ÙˆÙ„ - ØªØ¨Ø§ÙŠÙ† Ø¹Ø§Ù„ÙŠ */
        .dark input, .dark select, .dark textarea {
            background-color: #1f2937; 
            color: #f9fafb; 
            border-color: #4b5563;
        }
        .dark input::placeholder, .dark textarea::placeholder {
            color: #9ca3af;
        }
        .dark select option {
            background-color: #1f2937;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const SUPABASE_URL = "https://ozdnyepxfcjzldpkteau.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96ZG55ZXB4ZmNqemxkcGt0ZWF1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NDEwNTM3MiwiZXhwIjoyMDc5NjgxMzcyfQ.mtqFcdRZeidpC0Ul8r_8FJOJalToT4lZeHNqd3-fsOg";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const POINTS = { RIDDLE: 10 };
        
        const TRANSLATIONS = {
            ar: {
                appTitle: "BeØ¬ÙˆØ±ÙŠ", subTitle: "Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ÙƒÙ†ÙŠØ³Ø©", loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
                free: "Ù…Ø¬Ø§Ù†ÙŠ ğŸ", locked: "Ø§Ø¶ØºØ· Ù„Ù„ÙØªØ­", open: "Ù…ÙØªÙˆØ­ âœ…",
                loginTitle: "Ø§ÙƒØªØ¨ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø¯Ø¯", scanBtn: "ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§", manualBtn: "Ø§ÙƒØªØ¨ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø¯Ø¯", activateBtn: "ÙØªØ­ Ø§Ù„Ø¹Ø¯Ø¯ ğŸš€",
                errUsed: "Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„! ğŸš«", errWrong: "Ù…ÙØªØ§Ø­ Ù„Ø¹Ø¯Ø¯ Ø¢Ø®Ø±! âš ï¸", errInvalid: "Ù…ÙØªØ§Ø­ Ø®Ø§Ø·Ø¦! âŒ", errNetwork: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©.",
                verseTitle: "Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ… ğŸ•Šï¸", langBtn: "English",
                introTitle: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ø¬ÙˆØ±ÙŠ! ğŸ‘‹", introBody: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ BeØ¬ÙˆØ±ÙŠ.", introBtn: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš€",
                score: "Ø§Ù„Ù†ØªÙŠØ¬Ø©", playAgain: "Ø§Ù„Ø¹Ø¨ ØªØ§Ù†ÙŠ ğŸ”„",
                actRiddle: "ğŸ§  ÙÙˆØ§Ø²ÙŠØ±", riddleGen: "ÙØ²ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ²", riddlePlaceholder: "Ù…ÙŠÙ† Ù‡ÙˆØŸ", riddleCheck: "ØªØ®Ù…ÙŠÙ† âœ…", riddleWrong: "Ù„Ù„Ø£Ø³Ù ØºÙ„Ø· ğŸ˜¢", riddleCorrect: "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! ğŸ‰",
                joinFriends: "Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø©",
                apiError: "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.",
                keysFailed: "ØªÙ… Ø§Ø³ØªÙ†ÙØ§Ø° Ø¬Ù…ÙŠØ¹ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ! âš ï¸",
                contestTab: "ğŸ† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©", contestSubmit: "ØªØµØ­ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª âœ…", contestResult: "Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©",
                activitiesTab: "âœ¨ Ø£Ù†Ø´Ø·Ø©",
                storyTab: "âœ¨ Ù‚ØµØµ",
                reflectBtn: "âœ¨ ØªØ£Ù…Ù„", reflectTitle: "ØªØ£Ù…Ù„ ÙÙŠ Ø§Ù„Ø¢ÙŠØ©",
                riddleUserModalTitle: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„", riddleUserModalBody: "Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±ÙØŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù‚Ù… Ù‡Ø§ØªÙÙƒ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·).",
                riddleLeaderboard: "Ù„ÙˆØ­Ø© Ø´Ø±Ù Ø§Ù„ÙÙˆØ§Ø²ÙŠØ±",
                riddleHeroes: "Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ÙÙˆØ§Ø²ÙŠØ± ğŸ¥‡" // New button title
            },
            en: {
                appTitle: "BeJouri", subTitle: "Church Heroes", loading: "Loading...",
                free: "Free ğŸ", locked: "Tap to Unlock", open: "Open âœ…",
                loginTitle: "Enter Issue Key", scanBtn: "ğŸ“· Scan QR", manualBtn: "Enter Key", activateBtn: "Unlock Issue ğŸš€",
                errUsed: "Key Used! ğŸš«", errWrong: "Wrong Issue! âš ï¸", errInvalid: "Invalid Key! âŒ", errNetwork: "Network connection error.",
                verseTitle: "Verse of the Day ğŸ•Šï¸", langBtn: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
                introTitle: "Welcome Jouri! ğŸ‘‹", introBody: "Welcome to BeJouri app.", introBtn: "Start Journey ğŸš€",
                score: "Score", playAgain: "Play Again ğŸ”„",
                actRiddle: "ğŸ§  Riddles", riddleGen: "New Riddle ğŸ²", riddlePlaceholder: "Who is it?", riddleCheck: "Guess âœ…", riddleCorrect: "Correct! ğŸ‰", riddleWrong: "Wrong ğŸ˜¢",
                joinFriends: "Friends of the Mag",
                apiError: "AI connection error.",
                keysFailed: "All AI keys are exhausted! âš ï¸",
                contestTab: "ğŸ† Contest", contestSubmit: "Grade Answers âœ…", contestResult: "Contest Result",
                activitiesTab: "âœ¨ Activities",
                storyTab: "âœ¨ Stories",
                reflectBtn: "âœ¨ Reflect", reflectTitle: "Verse Reflection",
                riddleUserModalTitle: "Heroes Gate", riddleUserModalBody: "To join the leaderboard, please enter your name and phone number (only once).",
                riddleLeaderboard: "Riddles Leaderboard",
                riddleHeroes: "Riddle Heroes ğŸ¥‡"
            }
        };

        function getYoutubeEmbed(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) return `https://www.youtube.com/embed/${match[2]}`;
            return null;
        }
        
        async function checkCodeOnline(code, issueId) {
            try {
                const cleanCode = code.trim().toUpperCase();
                if(cleanCode === "ADMIN123") return { success: true };
                const { data: codeData, error } = await supabase.from('codes').select('*').eq('code', cleanCode).single();
                if (error || !codeData) return { success: false, error: "INVALID" };
                if (String(codeData.issue_id) !== String(issueId)) return { success: false, error: "WRONG_ISSUE" };
                if (codeData.used) return { success: false, error: "USED" };
                await supabase.from('codes').update({ used: true, used_at: new Date() }).eq('code', cleanCode);
                return { success: true };
            } catch (e) { console.error("Code check error:", e); return { success: false, error: "NET_ERROR" }; }
        }

        const callGemini = async (prompt, aiKeys, activeKeyIndex, setActiveKeyIndex, setAiKeys, setAllKeysFailed) => {
            let keys = [...aiKeys];
            let startingIndex = activeKeyIndex;
            const maxAttempts = keys.length || 1;
            if (keys.length === 0) { throw new Error("API_KEY_MISSING"); }
            for (let attempts = 0; attempts < maxAttempts; attempts++) {
                let keyFound = false;
                let currentIndex = startingIndex;
                for (let i = 0; i < keys.length; i++) {
                    const checkIndex = (startingIndex + i) % keys.length;
                    const keyObj = keys[checkIndex];
                    if (keyObj.status !== 'failed') { currentIndex = checkIndex; keyFound = true; break; }
                }
                if (!keyFound) { break; }
                const currentKeyObj = keys[currentIndex];
                const apiKey = currentKeyObj?.key;
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(url, { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) 
                    });
                    if (response.ok) {
                        setActiveKeyIndex(currentIndex); setAllKeysFailed(false); 
                        return (await response.json()).candidates?.[0]?.content?.parts?.[0]?.text || "No response";
                    }
                    console.warn(`API Call failed. Rotating key.`); currentKeyObj.status = 'failed'; 
                    setAiKeys([...keys]); startingIndex = (currentIndex + 1) % keys.length;
                    await new Promise(resolve => setTimeout(resolve, 500)); 
                } catch (e) {
                    console.error(`Network error:`, e); currentKeyObj.status = 'network_failed'; 
                    setAiKeys([...keys]); startingIndex = (currentIndex + 1) % keys.length;
                    await new Promise(resolve => setTimeout(resolve, 500)); 
                }
            }
            setAllKeysFailed(true); throw new Error("ALL_KEYS_FAILED");
        };

        function MessageModal({ message, onClose, type = 'error' }) {
            let icon, color;
            switch(type) {
                case 'success': icon = 'ğŸ‰'; color = 'bg-green-100 text-green-800 border-green-500'; break;
                case 'warning': icon = 'âš ï¸'; color = 'bg-yellow-100 text-yellow-800 border-yellow-500'; break;
                default: icon = 'âŒ'; color = 'bg-red-100 text-red-800 border-red-500'; break;
            }
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-fade-in">
                    <div className={`bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-xs text-center shadow-2xl border-4 ${color} relative overflow-hidden animate-pop-in`}>
                        <div className="text-4xl mb-4">{icon}</div>
                        <p className="text-lg font-bold text-gray-800 dark:text-gray-200 mb-6 leading-relaxed">{message}</p>
                        <button onClick={onClose} className="w-full bg-indigo-600 text-white py-2 rounded-xl font-bold text-lg shadow-lg hover:scale-[1.02] transition transform">Ø­Ø³Ù†Ø§Ù‹</button>
                    </div>
                </div>
            );
        }

        function IntroModal({ onClose, data, t }) {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-fade-in">
                    <div className="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-sm text-center shadow-2xl border-4 border-indigo-500 relative overflow-hidden animate-pop-in">
                        <div className="text-6xl mb-6 animate-bounce">ğŸ‘‹â¤ï¸</div>
                        <h2 className="text-2xl font-black text-indigo-800 dark:text-white mb-4">{data.title || t.introTitle}</h2>
                        <p className="text-lg text-gray-600 dark:text-gray-300 mb-8 leading-relaxed">{data.body || t.introBody}</p>
                        <button onClick={onClose} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-black text-xl shadow-lg hover:scale-105 transition transform">{t.introBtn}</button>
                    </div>
                </div>
            );
        }

        function FriendsModal({ t, onClose, setAlert }) {
            const [data, setData] = React.useState({ name: '', phone: '', grade: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', talent: '' });
            const [loading, setLoading] = React.useState(false);

            const handleSubmit = async () => {
                if (!data.name || !data.phone) return setAlert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù…");
                setLoading(true);
                try {
                    const { error } = await supabase.from('children').insert([{ full_name: data.name, phone: data.phone, grade: data.grade, talent: data.talent, points: 0 }]);
                    if (error && error.code !== '23505') throw error;
                    setAlert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰", 'success');
                    localStorage.setItem('bejouri_friend_joined', 'true');
                    onClose();
                } catch (e) { setAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø³ÙŠØ·ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."); } finally { setLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-indigo-900/95 backdrop-blur-xl animate-fade-in">
                    <div className="bg-white dark:bg-gray-800 w-full max-w-md p-8 rounded-3xl shadow-2xl relative animate-pop-in border-4 border-yellow-400">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-xl font-bold">âœ•</button>
                        <div className="text-center mb-6">
                            <div className="text-5xl mb-2">ğŸ¤</div>
                            <h2 className="text-2xl font-black text-indigo-900 dark:text-white">Ø³Ø¬Ù„ ÙÙŠ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø©</h2>
                            <p className="text-sm text-gray-500 dark:text-gray-300">Ù…Ø´ Ø¥Ø¬Ø¨Ø§Ø±ÙŠØŒ Ø¨Ø³ Ø¨Ù†Ø­Ø¨ Ù†Ø¹Ø±Ù Ø£ØµØ­Ø§Ø¨Ù†Ø§ â¤ï¸</p>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ</label>
                                <input value={data.name} onChange={e=>setData({...data, name: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-xl font-bold text-indigo-900 dark:text-white outline-none focus:border-yellow-400 dark:focus:border-yellow-400 transition"/>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-2">Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</label>
                                <input type="tel" value={data.phone} onChange={e=>setData({...data, phone: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-xl font-bold text-indigo-900 dark:text-white outline-none focus:border-yellow-400 dark:focus:border-yellow-400 transition"/>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
                                <select value={data.grade} onChange={e=>setData({...data, grade: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-xl font-bold text-indigo-900 dark:text-white outline-none focus:border-yellow-400 dark:focus:border-yellow-400 transition cursor-pointer">
                                    <option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-2">Ù…ÙˆÙ‡Ø¨ØªÙƒ Ø¥ÙŠÙ‡ØŸ</label>
                                <input value={data.talent} onChange={e=>setData({...data, talent: e.target.value})} placeholder="Ø±Ø³Ù…ØŒ ØªØ±Ù†ÙŠÙ…ØŒ Ø´Ø¹Ø±..." className="w-full p-3 bg-gray-50 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-xl font-bold text-indigo-900 dark:text-white outline-none focus:border-yellow-400 dark:focus:border-yellow-400 transition"/>
                            </div>
                            
                            <button onClick={handleSubmit} disabled={loading} className="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-4 rounded-xl font-black text-xl shadow-lg hover:scale-105 transition transform mt-4">
                                {loading ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„..." : "Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù† ğŸš€"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function ContestResultModal({ score, total, issueId, onClose, setAlert }) {
            const [data, setData] = React.useState({ name: '', phone: '', grade: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ' });
            const [loading, setLoading] = React.useState(false);
            
            const saveResult = async () => {
                if(!data.name || !data.phone) return setAlert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù‚Ù…Ùƒ Ù„Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©!");
                setLoading(true);
                try {
                    // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„Ù…ÙˆÙ‡Ø¨Ø© Ù…Ù† Ù‡Ù†Ø§
                    await supabase.from('contest_submissions').insert([{ 
                        issue_id: issueId, 
                        student_name: data.name, 
                        student_phone: data.phone, 
                        score: score, 
                        total: total,
                        student_grade: data.grade, 
                        student_talent: '' 
                    }]);
                    setAlert("ØªÙ… Ø­ÙØ¸ Ù†ØªÙŠØ¬ØªÙƒ ÙŠØ§ Ø¨Ø·Ù„! ğŸ†", 'success');
                    onClose();
                } catch(e) { 
                    console.error("Contest Save Error:", e);
                    setAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯."); 
                } finally { setLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border-4 border-purple-500 animate-pop-in">
                        <div className="text-6xl mb-4">ğŸ“¸</div>
                        <h3 className="text-2xl font-black text-purple-900 dark:text-white mb-2">Ù…Ø¨Ø±ÙˆÙƒ Ø§Ù„Ù†Ø¬Ø§Ø­!</h3>
                        <p className="text-gray-600 dark:text-gray-300 mb-6">Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</p>
                        
                        <div className="space-y-3">
                            <input value={data.name} onChange={e=>setData({...data, name: e.target.value})} placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" className="w-full p-3 border-2 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl font-bold"/>
                            <input value={data.phone} onChange={e=>setData({...data, phone: e.target.value})} placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†" className="w-full p-3 border-2 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl font-bold"/>
                            
                            <select value={data.grade} onChange={e=>setData({...data, grade: e.target.value})} className="w-full p-3 border-2 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl font-bold cursor-pointer">
                                <option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                <option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                <option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                <option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                <option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                <option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            </select>
                        </div>

                        <button onClick={saveResult} disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded-xl font-black hover:bg-purple-700 mt-4">
                            {loading?"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...":"Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ğŸ’¾"}
                        </button>
                        <button onClick={onClose} className="mt-3 text-gray-400 text-sm underline">Ù„Ø§ Ø´ÙƒØ±Ø§Ù‹</button>
                    </div>
                </div>
            );
        }
        
        function RiddleUserModal({ t, onClose, onUserSet, setAlert }) {
            const [mode, setMode] = React.useState('login'); 
            const [data, setData] = React.useState({ name: '', phone: '' });
            const [loading, setLoading] = React.useState(false);
            
            const handleFormSubmit = async () => {
                if (!data.phone) return setAlert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ!");
                setLoading(true);
                
                try {
                    const { data: existingUser, error: fetchError } = await supabase.from('riddles_scores').select('*').eq('user_phone', data.phone).maybeSingle();
                    if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;
                    
                    if (existingUser) {
                        onUserSet(existingUser);
                        setAlert(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${existingUser.user_name.split(' ')[0]}!`, 'success');
                        localStorage.setItem('bejouri_riddle_user', JSON.stringify(existingUser));
                        onClose();
                    } else if (mode === 'register' && data.name) {
                        const { data: newUser, error: insertError } = await supabase.from('riddles_scores').insert([{ user_name: data.name, user_phone: data.phone, score: 0 }]).select('*').single();
                        if (insertError) throw insertError;

                        onUserSet(newUser);
                        setAlert("ØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø´Ø±Ù Ø§Ù„ÙÙˆØ§Ø²ÙŠØ±! ğŸ‰", 'success');
                        localStorage.setItem('bejouri_riddle_user', JSON.stringify(newUser));
                        onClose();
                    } else {
                        setMode('register');
                        setAlert("Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ù„Ù„ØªØ³Ø¬ÙŠÙ„.", 'warning');
                    }
                } catch (e) {
                    console.error("Riddle Auth Error:", e);
                    setAlert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="fixed inset-0 z-[65] flex items-center justify-center p-4 bg-purple-900/95 backdrop-blur-xl animate-fade-in">
                    <div className="bg-white dark:bg-gray-800 w-full max-w-sm p-8 rounded-3xl shadow-2xl relative animate-pop-in border-4 border-yellow-400">
                        <div className="text-center mb-6">
                            <div className="text-5xl mb-2">ğŸ…</div>
                            <h2 className="text-xl font-black text-purple-800 dark:text-white">{t.riddleUserModalTitle}</h2>
                            <p className="text-sm text-gray-500 dark:text-gray-300 mt-2">{t.riddleUserModalBody}</p>
                        </div>
                        <div className="flex justify-center mb-4">
                            <button onClick={()=>setMode('login')} className={`px-4 py-2 font-bold ${mode === 'login' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-400'}`}>Ø¯Ø®ÙˆÙ„</button>
                            <button onClick={()=>setMode('register')} className={`px-4 py-2 font-bold ${mode === 'register' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-400'}`}>ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
                        </div>
                        <div className="space-y-4">
                            {mode === 'register' && <input value={data.name} onChange={e=>setData({...data, name: e.target.value})} placeholder="Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" className="w-full p-3 border-2 rounded-xl dark:bg-gray-700 dark:text-white outline-none"/>}
                            <input type="tel" value={data.phone} onChange={e=>setData({...data, phone: e.target.value})} placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ" className="w-full p-3 border-2 rounded-xl dark:bg-gray-700 dark:text-white outline-none"/>
                            <button onClick={handleFormSubmit} disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded-xl font-black hover:bg-purple-700 transition">
                                {loading ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©..." : (mode === 'register' ? "ØªØ³Ø¬ÙŠÙ„ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ ğŸš€" : "Ø¯Ø®ÙˆÙ„ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ ğŸ…")}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }


        function ActivitiesView({ t, setAlert, aiCall, riddleUser, setRiddleUser }) {
            const [mode, setMode] = React.useState(riddleUser ? 'menu' : 'register'); 
            const [data, setData] = React.useState(null); 
            const [input, setInput] = React.useState(""); 
            const [feedback, setFeedback] = React.useState(""); 
            const [loading, setLoading] = React.useState(false);
            
            const [history, setHistory] = React.useState(JSON.parse(localStorage.getItem('bejouri_riddle_history') || '[]'));

            const updateRiddleScore = async (score) => {
                if (!riddleUser || score === 0) return;
                
                try {
                    const newScore = riddleUser.score + score;
                    const { data: updatedUser, error } = await supabase.from('riddles_scores')
                        .update({ score: newScore, last_update: new Date() })
                        .eq('id', riddleUser.id)
                        .select('*').single();
                    if (error) throw error;
                    setRiddleUser(updatedUser);
                } catch(e) {
                    console.error("Failed to update riddle score:", e);
                }
            };

            const generateRiddle = async () => {
                if (!riddleUser) return setMode('register'); 

                setLoading(true); setFeedback(""); setInput("");
                try { 
                    const avoidList = history.slice(-20).join(", "); 
                    const prompt = `You are a super intelligent, fun Sunday School teacher. 
                    Generate a NEW, UNIQUE, and EASY riddle in Egyptian Arabic about a Coptic Saint, Bible character, or church object.
                    CRITICAL: Do NOT generate riddles about: [${avoidList}].
                    Return ONLY JSON: { "riddle": "...", "answer": "..." }.`;
                    
                    const rawText = await aiCall(prompt);
                    const parsedData = JSON.parse(rawText.replace(/```json/g, '').replace(/```/g, '').trim());
                    setData(parsedData);
                    
                    const newHistory = [...history, parsedData.answer];
                    setHistory(newHistory);
                    localStorage.setItem('bejouri_riddle_history', JSON.stringify(newHistory));

                } catch(e) { setAlert(t.apiError); setMode('menu'); } 
                setLoading(false);
            };

            const checkRiddle = async () => {
                if(!input || !data) return; 
                setLoading(true);
                try { 
                    const prompt = `Act as a lenient teacher.
                    Model Answer: "${data.answer}". 
                    Student Guess: "${input}". 
                    Is the guess correct? 
                    RULES: Accept synonyms, partial names (e.g. "George" for "Saint George"), and minor spelling mistakes in Arabic.
                    Return ONLY JSON: { "correct": true/false }.`;
                    
                    const rawText = await aiCall(prompt);
                    const json = JSON.parse(rawText.replace(/```json/g, '').replace(/```/g, '').trim());
                    setFeedback(json.correct ? "correct" : "wrong");
                    if (json.correct) {
                        await updateRiddleScore(POINTS.RIDDLE);
                    }
                } catch(e) { setFeedback("wrong"); } 
                setLoading(false);
            };

            if(mode === 'register') return <RiddleUserModal t={t} onClose={()=>setMode('menu')} onUserSet={(user)=>{setRiddleUser(user); setMode('menu');}} setAlert={setAlert} />;

            if(mode === 'menu') return <div className="h-full flex flex-col items-center justify-center p-6 gap-4"><button onClick={()=>{setMode('riddle'); generateRiddle();}} className="w-full max-w-xs p-6 bg-purple-500 rounded-2xl text-white font-black text-xl shadow-lg hover:bg-purple-600 transition transform hover:scale-105">{t.actRiddle}</button></div>;
            
            if(mode === 'riddle') return (
                <div className="h-full flex flex-col p-6 text-center overflow-y-auto bg-gray-50 dark:bg-gray-900 relative overflow-hidden">
                    {feedback === 'correct' && <div className="absolute inset-0 pointer-events-none z-50 flex items-center justify-center">{[...Array(20)].map((_, i) => <div key={i} className="confetti" style={{left: `${Math.random()*100}%`, animationDuration:`${Math.random()*2+1}s`}}></div>)}</div>}
                    {feedback === 'wrong' && <div className="absolute inset-0 pointer-events-none z-50"><div className="absolute inset-0 bg-blue-900/20"></div>{[...Array(10)].map((_, i) => <div key={i} className="tear" style={{left: `${Math.random()*100}%`}}></div>)}</div>}
                    <button onClick={()=>setMode('menu')} className="self-start mb-4 text-indigo-600 dark:text-indigo-400 font-bold z-10 relative"><span className="transform rotate-180 inline-block">âœ</span> Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                    {riddleUser && <div className="self-end bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-bold shadow-md relative z-10">Ù†Ù‚Ø§Ø·Ùƒ: {riddleUser.score} â­</div>}
                    {loading && !data ? (<div className="flex flex-col items-center justify-center h-full"><span className="text-4xl animate-bounce">ğŸ²</span><p className="mt-4 text-gray-500">{t.loading}</p></div>) : (
                        <div className="flex flex-col items-center z-10 relative w-full">
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl mb-4 w-full border-2 border-purple-200"><p className="text-lg font-bold text-gray-800 dark:text-white leading-relaxed">{data?.riddle}</p></div>
                            {feedback !== 'correct' && (<div className="flex gap-2 w-full max-w-md"><input value={input} onChange={e=>setInput(e.target.value)} placeholder={t.riddlePlaceholder} className="flex-1 p-3 border-2 rounded-xl text-center outline-none dark:bg-gray-700 dark:text-white" /><button onClick={checkRiddle} disabled={loading} className="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:bg-purple-700 transition">{loading ? "..." : t.riddleCheck}</button></div>)}
                            {feedback === 'correct' && <div className="mt-4 bg-green-100 p-6 rounded-3xl w-full max-w-md text-green-800 font-black animate-pop-in border-4 border-green-500 shadow-2xl"><div className="text-6xl mb-2 animate-bounce">ğŸ‰ğŸ†</div>{t.riddleCorrect}</div>}
                            {feedback === 'wrong' && <div className="mt-4 bg-red-100 p-6 rounded-3xl w-full max-w-md text-red-800 font-bold animate-fade-in border-4 border-red-500 shadow-2xl">{t.riddleWrong}</div>}
                            <button onClick={generateRiddle} disabled={loading} className="mt-6 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-6 py-2 rounded-full font-bold shadow hover:bg-purple-200 transition">{loading ? t.loading : t.riddleGen}</button>
                        </div>
                    )}
                </div>
            );
        }

        function ContestView({ issue, t, setAlert, aiCall }) {
            const [userAnswers, setUserAnswers] = React.useState({});
            const [result, setResult] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [submitted, setSubmitted] = React.useState(false);
            const [showSaveModal, setShowSaveModal] = React.useState(false);

            const submitAnswers = async () => {
                const questions = issue.contest || [];
                const answeredCount = Object.keys(userAnswers).filter(i => userAnswers[i] !== '').length;
                
                if (answeredCount < questions.length) return setAlert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø¬Ø§ÙˆØ¨ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!");
                setLoading(true);
                try {
                    let prompt = `Act as a smart, flexible teacher grading a quiz.
                    Questions, Model Answers, Student Answers (Arabic) provided.
                    GRADING RULES:
                    1. Accept spelling mistakes.
                    2. Accept synonyms (e.g. "Ù…Ù„Ø§Ø®ÙŠ" = "Ù…Ù„Ø§Ø®ÙŠ Ø§Ù„Ù†Ø¨ÙŠ").
                    3. Determine correctness based on meaning.
                    
                    Questions: `;
                    questions.forEach((q, i) => prompt += `Q${i+1}: ${q.question} \n Model: ${q.answer} \n Student: ${userAnswers[i]||"No"} \n ---\n`);
                    prompt += `Return ONLY JSON: { "score": number, "total": number, "details": [{ "q_index": 0, "correct": true/false, "feedback": "Short Arabic feedback" }], "final_feedback": "Encouraging Arabic comment" }`;
                    
                    const rawResponse = await aiCall(prompt);
                    const jsonResult = JSON.parse(rawResponse.replace(/```json/g, '').replace(/```/g, '').trim());
                    
                    setResult(jsonResult);
                    setSubmitted(true);
                    
                    if(jsonResult.score >= Math.ceil(jsonResult.total/2)) {
                        setTimeout(() => setShowSaveModal(true), 2000);
                    } else {
                        setAlert("Ù„Ù„Ø£Ø³ÙØŒ Ù„Ù… ØªÙ†Ø¬Ø­ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!", 'error');
                    }
                } catch (e) { 
                    console.error("Contest Grading Error:", e);
                    setAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­."); 
                } finally { 
                    setLoading(false); 
                }
            };

            const questions = issue.contest || [];
            if (questions.length === 0) return <div className="p-8 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¨Ù‚Ø©.</div>;

            if (submitted && result) {
                return (
                    <div className="h-full p-6 overflow-y-auto bg-gray-50 dark:bg-gray-900 text-center animate-fade-in relative">
                        {showSaveModal && <ContestResultModal score={result.score} total={result.total} issueId={issue.id} onClose={()=>setShowSaveModal(false)} setAlert={setAlert} />}
                        <div className="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl max-w-lg mx-auto border-t-8 border-purple-500">
                            <div className="text-6xl mb-4">{result.score === result.total ? 'ğŸ†' : 'ğŸ‰'}</div>
                            <h2 className="text-2xl font-black text-gray-800 dark:text-white mb-2">{t.contestResult}</h2>
                            <div className="text-4xl font-black text-purple-600 mb-4">{result.score} / {result.total}</div>
                            <p className="text-gray-600 dark:text-gray-300 mb-6 font-bold">{result.final_feedback}</p>
                            <div className="space-y-3 text-right">
                                {result.details && result.details.map((d, i) => (
                                    <div key={i} className={`p-3 rounded-xl border ${d.correct ? 'bg-green-50' : 'bg-red-50'}`}>
                                        <div className="font-bold text-sm mb-1">{questions[d.q_index]?.question}</div>
                                        <div className={`text-xs font-bold ${d.correct ? 'text-green-700' : 'text-red-700'}`}>{d.correct ? 'âœ…' : 'âŒ'} {d.feedback}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full p-6 overflow-y-auto bg-indigo-50 dark:bg-gray-900">
                    <div className="max-w-2xl mx-auto space-y-6">
                        <div className="text-center mb-6"><h2 className="text-2xl font-black text-indigo-800 dark:text-white">ğŸ† Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø¯Ø¯</h2></div>
                        {questions.map((q, i) => (
                            <div key={i} className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-indigo-100">
                                <label className="block font-bold text-lg mb-3 text-gray-800 dark:text-white"><span className="text-indigo-500 ml-2">#{i+1}</span>{q.question}</label>
                                {q.options && q.options.length > 0 ? (
                                    <div className="space-y-2">
                                        {q.options.map((opt, idx) => (
                                            <label key={idx} className="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <input type="radio" name={`q-${i}`} value={opt} checked={userAnswers[i] === opt} onChange={e => setUserAnswers({...userAnswers, [i]: e.target.value})} className="w-5 h-5 accent-indigo-600"/>
                                                <span className="font-bold text-gray-700 dark:text-gray-200">{opt}</span>
                                            </label>
                                        ))}
                                    </div>
                                ) : (
                                    <textarea value={userAnswers[i] || ''} onChange={e => setUserAnswers({...userAnswers, [i]: e.target.value})} placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ..." className="w-full p-4 rounded-xl bg-gray-50 border-2 outline-none dark:bg-gray-700 dark:text-white"/>
                                )}
                            </div>
                        ))}
                        <button onClick={submitAnswers} disabled={loading} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-black shadow-lg">{loading ? "..." : t.contestSubmit}</button>
                    </div>
                </div>
            );
        }

        function IssueDetail({ issue, onBack, t, setAlert, aiCall }) {
            const hasContest = issue.contest && issue.contest.length > 0;
            const hideMagazine = issue.hide_magazine === true; 
            
            // âœ… Logic to set the initial tab
            let initialTab;
            if (!hideMagazine) {
                initialTab = 'mag';
            } else if (issue.videos && issue.videos.length > 0) {
                 initialTab = 'video';
            } else if (hasContest) {
                initialTab = 'contest';
            } else {
                initialTab = 'activities';
            }

            const [tab, setTab] = React.useState(initialTab);

            return (
                <div className="h-screen flex flex-col bg-white dark:bg-gray-900">
                    <div className="flex items-center justify-between p-3 border-b dark:border-gray-800 shadow-sm z-20">
                        <button onClick={onBack} className="w-10 h-10 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center font-bold text-indigo-600 dark:text-indigo-400 transform rotate-180 shadow hover:bg-gray-200 transition">âœ</button>
                        <div className="text-sm font-black truncate px-2 dark:text-white">{issue.title.ar}</div>
                        <div className="w-10"></div>
                    </div>
                    <div className="flex justify-around bg-indigo-50 dark:bg-gray-800 p-1 overflow-x-auto">
                        {!hideMagazine && <button onClick={()=>setTab('mag')} className={`flex-1 py-2 text-xs font-bold rounded-lg min-w-[80px] ${tab==='mag'?'bg-white dark:bg-gray-900 text-indigo-600 shadow':'text-gray-500'}`}>ğŸ“– Ø§Ù„Ù…Ø¬Ù„Ø©</button>}
                        <button onClick={()=>setTab('video')} className={`flex-1 py-2 text-xs font-bold rounded-lg min-w-[80px] ${tab==='video'?'bg-white dark:bg-gray-900 text-indigo-600 shadow':'text-gray-500'}`}>ğŸ“º ÙÙŠØ¯ÙŠÙˆ</button>
                        <button onClick={()=>setTab('activities')} className={`flex-1 py-2 text-xs font-bold rounded-lg min-w-[80px] ${tab==='activities'?'bg-white dark:bg-gray-900 text-indigo-600 shadow':'text-gray-500'}`}>{t.activitiesTab}</button>
                        {hasContest && <button onClick={()=>setTab('contest')} className={`flex-1 py-2 text-xs font-bold rounded-lg min-w-[80px] ${tab==='contest'?'bg-white dark:bg-gray-900 text-purple-600 shadow border-b-2 border-purple-500':'text-gray-500'}`}>{t.contestTab}</button>}
                    </div>
                    <div className="flex-1 bg-gray-100 dark:bg-black relative overflow-hidden">
                        {!hideMagazine && tab === 'mag' && <iframe src={issue.magazine_url} className="w-full h-full border-none bg-white"></iframe>}
                        {tab === 'video' && <div className="h-full overflow-y-auto p-4 space-y-6">{issue.videos && issue.videos.map((v, i) => (<div key={i} className="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700"><h3 className="text-lg font-bold text-gray-800 dark:text-white mb-3 text-right">{v.title}</h3><div className="aspect-video bg-black rounded-xl overflow-hidden shadow-inner"><iframe src={getYoutubeEmbed(v.url)} className="w-full h-full" allowFullScreen></iframe></div></div>))}</div>}
                        {tab === 'activities' && <ActivitiesView t={t} setAlert={setAlert} aiCall={aiCall} riddleUser={window.riddleUser} setRiddleUser={window.setRiddleUser} />}
                        {hasContest && tab === 'contest' && <ContestView issue={issue} t={t} setAlert={setAlert} aiCall={aiCall} />}
                    </div>
                </div>
            );
        }

        function UnlockView({ onUnlock, t, error, processing }) {
            const [code, setCode] = React.useState("");
            const [scanning, setScanning] = React.useState(false);
            const html5QrCodeRef = React.useRef(null);

            React.useEffect(() => {
                return () => { if (html5QrCodeRef.current && html5QrCodeRef.current.isScanning) { html5QrCodeRef.current.stop().catch(err => console.error(err)); } };
            }, []);

            const startScan = () => { 
                setScanning(true); 
                window.stopScan = () => { if (html5QrCodeRef.current && html5QrCodeRef.current.isScanning) html5QrCodeRef.current.stop().catch(err => console.error(err)); html5QrCodeRef.current = null; setScanning(false); delete window.stopScan; };
                
                setTimeout(() => { 
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCodeRef.current = html5QrCode;
                    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                        (decoded) => { window.stopScan(); onUnlock(decoded); }, 
                        (err) => { }
                    ).catch(err => { console.error(err); setScanning(false); }); 
                }, 100); 
            };

            return (
                <div className="flex flex-col items-center text-center">
                    <h2 className="text-2xl font-black mb-4 dark:text-white">{t.loginTitle}</h2>
                    {scanning ? <div id="reader" className="w-full h-64 bg-black mb-4 rounded-xl"></div> : <button onClick={startScan} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-black text-lg mb-4 shadow-lg">{t.scanBtn}</button>}
                    <input value={code} onChange={e=>setCode(e.target.value.toUpperCase())} placeholder={t.manualBtn} className="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700 dark:text-white text-center font-bold mb-3 border-2 outline-none" />
                    <button onClick={()=>onUnlock(code)} disabled={processing} className="w-full py-3 bg-yellow-400 font-black text-lg rounded-xl shadow-lg">{processing ? "..." : t.activateBtn}</button>
                    {error && <div className="mt-4 p-2 bg-red-100 text-red-700 font-bold rounded-lg border border-red-300 w-full">{error}</div>}
                </div>
            );
        }

        // âœ… NEW: Riddle Heroes Modal (Leaderboard)
        function RiddleHeroesModal({ t, onClose, riddleUser }) {
            const [leaders, setLeaders] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [userRank, setUserRank] = React.useState(null);

            const fetchLeadersAndRank = async () => {
                setLoading(true);
                // 1. Fetch Leaders (Top 3)
                const { data: topLeaders } = await supabase.from('riddles_scores').select('*').order('score', { ascending: false }).limit(3);
                setLeaders(topLeaders || []);
                
                // 2. Calculate Rank (only if user is logged in)
                if (riddleUser?.user_phone) {
                    const { count } = await supabase.from('riddles_scores')
                        .select('id', { count: 'exact' })
                        .order('score', { ascending: false });
                    
                    const myRank = topLeaders.findIndex(l => l.user_phone === riddleUser.user_phone);

                    if (myRank !== -1) {
                        setUserRank({ rank: myRank + 1, total: count });
                    } else if (count > 3) {
                         // Fallback for calculating rank if outside top 3
                         const { count: higherCount } = await supabase.from('riddles_scores')
                            .select('id', { count: 'exact' })
                            .gt('score', riddleUser.score);
                        setUserRank({ rank: higherCount + 1, total: count });
                    } else {
                        setUserRank({ rank: count, total: count });
                    }
                } else {
                    setUserRank(null);
                }
                setLoading(false);
            };

            React.useEffect(() => {
                fetchLeadersAndRank();
                const interval = setInterval(fetchLeadersAndRank, 60000); // Refresh every minute
                return () => clearInterval(interval);
            }, [riddleUser]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-purple-900/90 backdrop-blur-md animate-fade-in">
                    <div className="bg-white dark:bg-gray-800 w-full max-w-sm p-8 rounded-3xl shadow-2xl relative animate-pop-in border-4 border-yellow-400">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-xl font-bold">âœ•</button>
                        <h2 className="text-2xl font-black text-yellow-700 dark:text-yellow-400 mb-6 text-center">ğŸ¥‡ {t.riddleHeroes}</h2>
                        
                        <div className="space-y-4">
                            <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-inner">
                                <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-3 text-center">Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</h3>
                                {loading ? (<p className="text-center text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>) : (
                                    <div className="space-y-2">
                                        {leaders.map((l, index) => (
                                            <div key={l.id} className="flex justify-between items-center p-3 rounded-lg bg-white dark:bg-gray-800 shadow-md">
                                                <span className={`font-black text-lg ${index < 3 ? 'text-yellow-500' : 'text-purple-600'}`}>#{index + 1}</span>
                                                <span className="font-bold text-gray-800 dark:text-white flex-1 text-right mr-3">{l.user_name.split(' ')[0]}</span>
                                                <span className="font-black text-green-600">{l.score} â­</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            {riddleUser && userRank && (
                                <div className="bg-indigo-50 dark:bg-indigo-900 p-4 rounded-xl text-center border-2 border-indigo-400">
                                    <h3 className="font-black text-indigo-700 dark:text-indigo-300 mb-2">Ø£Ù†Ø§ Ø§Ù„Ø¨Ø·Ù„!</h3>
                                    <p className="text-gray-700 dark:text-gray-300 font-bold">Ù†Ù‚Ø§Ø·ÙŠ: <span className="font-black text-xl text-green-600">{riddleUser.score}</span></p>
                                    {userRank.rank && <p className="text-gray-700 dark:text-gray-300 font-bold">ØªØ±ØªÙŠØ¨ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span className="font-black text-xl text-red-600">#{userRank.rank}</span></p>}
                                </div>
                            )}
                            {!riddleUser && (
                                <div className="p-2 text-center text-gray-500 dark:text-gray-300 text-sm">
                                    Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù„ØªØ±Ù‰ ØªØ±ØªÙŠØ¨Ùƒ!
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        }


        function App() {
            const [view, setView] = React.useState("home");
            const [lang, setLang] = React.useState(localStorage.getItem('bejouri_lang') || 'ar');
            const [theme, setTheme] = React.useState(localStorage.getItem('bejouri_theme') || 'light');
            const [issues, setIssues] = React.useState([]);
            const [activeIssue, setActiveIssue] = React.useState(null);
            const [dailyVerse, setDailyVerse] = React.useState(null);
            
            const [showUnlock, setShowUnlock] = React.useState(false);
            const [targetIssueId, setTargetIssueId] = React.useState(null);
            const [unlockError, setUnlockError] = React.useState("");
            const [verifying, setVerifying] = React.useState(false);
            const [unlockedIssues, setUnlockedIssues] = React.useState(JSON.parse(localStorage.getItem('bejouri_unlocked_list') || '[]'));

            const [appBg, setAppBg] = React.useState('');
            const [appLogo, setAppLogo] = React.useState('');
            const [introData, setIntroData] = React.useState({}); 
            const [showIntro, setShowIntro] = React.useState(true); 
            const [showFriendsForm, setShowFriendsForm] = React.useState(false); 
            const [showRiddlesHeroes, setShowRiddlesHeroes] = React.useState(false); // NEW STATE
            
            const [reflection, setReflection] = React.useState("");
            const [reflecting, setReflecting] = React.useState(false);
            
            const [alertMessage, setAlertMessage] = React.useState(null);
            const [alertType, setAlertType] = React.useState('error');

            const [aiKeys, setAiKeys] = React.useState([]);
            const [activeKeyIndex, setActiveKeyIndex] = React.useState(0);
            const [allKeysFailed, setAllKeysFailed] = React.useState(false);

            const [riddleUser, setRiddleUser] = React.useState(() => {
                const storedUser = localStorage.getItem('bejouri_riddle_user');
                return storedUser ? JSON.parse(storedUser) : null;
            });
            
            // Expose riddleUser and setter globally for ActivitiesView
            React.useEffect(() => {
                window.riddleUser = riddleUser;
                window.setRiddleUser = setRiddleUser;
            }, [riddleUser]);

            const t = TRANSLATIONS[lang];
            const setAppAlert = (msg, type='error') => { setAlertMessage(msg); setAlertType(type); };

            const aiCallWithKeys = React.useCallback(async (prompt) => {
                return callGemini(prompt, aiKeys, activeKeyIndex, setActiveKeyIndex, setAiKeys, setAllKeysFailed);
            }, [aiKeys, activeKeyIndex]);

            // Reflection Listener: Updates state when IssueDetail saves a reflection to storage
            React.useEffect(() => {
                const handleStorageChange = () => {
                    const cache = localStorage.getItem('bejouri_reflection_cache');
                    if (cache) {
                        try { setReflection(JSON.parse(cache).text); } catch { setReflection(""); }
                    } else { setReflection(""); }
                };
                handleStorageChange(); 
                window.addEventListener('storage', handleStorageChange);
                return () => window.removeEventListener('storage', handleStorageChange);
            }, []);
            
            const handleReflectionClick = async (verse) => {
                setReflecting(true); 
                setReflection(""); 
                localStorage.removeItem('bejouri_reflection_cache');
                
                try {
                    const text = await aiCallWithKeys(`Write a short Coptic contemplation for a child in Arabic about: "${verse}"`);
                    const result = { verse, text };
                    localStorage.setItem('bejouri_reflection_cache', JSON.stringify(result));
                    setReflection(text); 
                } catch(e) { 
                    setAppAlert(t.apiError, 'error'); 
                } 
                setReflecting(false); 
            };
            
            // Main Data Fetching (Keys and Issues)
            React.useEffect(() => {
                if (theme === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
                document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                
                const init = async () => {
                    const { data: settings } = await supabase.from('settings').select('value').eq('key', 'config').maybeSingle();
                    let keys = [];
                    if (settings?.value) {
                        setAppBg(`url("${settings.value.appBackground || ''}")`);
                        setAppLogo(settings.value.appLogo || '');
                        setIntroData({ title: settings.value.introTitle, body: settings.value.introBody });
                        keys = settings.value.gemini_keys_list || [];
                        setAiKeys(keys);
                    } else {
                        setAiKeys([]);
                    }

                    const { data: issuesData } = await supabase.from('issues').select('*').order('created_at', { ascending: false });
                    if (issuesData) setIssues(issuesData);
                    
                    if (riddleUser?.user_phone) {
                        const { data: updatedUser } = await supabase.from('riddles_scores').select('*').eq('user_phone', riddleUser.user_phone).maybeSingle();
                        if (updatedUser) setRiddleUser(updatedUser);
                    }
                };
                init();
            }, [lang, theme]);

            // Daily Verse Logic
            React.useEffect(() => {
                if (issues.length > 0 && aiKeys.length > 0 && !allKeysFailed) {
                    const latest = issues[0];
                    const today = new Date().toDateString();
                    const storageKey = `bejouri_daily_verse_${latest.id}_${today}`;
                    
                    const cached = localStorage.getItem(storageKey);
                    
                    if (cached) {
                        setDailyVerse(JSON.parse(cached));
                    } else {
                        if (!dailyVerse && latest.verse && latest.verse.text) setDailyVerse(latest.verse); 
                        
                        const fetchVerse = async () => {
                            try {
                                const prompt = `You are a Sunday School teacher. Suggest a Bible verse in Arabic related to the topic: "${latest.title.ar}". Return ONLY valid JSON: { "text": "Verse text", "ref": "Reference" }.`;
                                const raw = await aiCallWithKeys(prompt);
                                const json = JSON.parse(raw.replace(/```json/g, '').replace(/```/g, '').trim());
                                if (json.text && json.ref) {
                                    setDailyVerse(json);
                                    localStorage.setItem(storageKey, JSON.stringify(json));
                                }
                            } catch (e) { 
                                setDailyVerse(latest.verse); 
                            }
                        };
                        fetchVerse();
                    }
                } else if (issues.length > 0 && !dailyVerse) {
                     setDailyVerse(issues[0].verse); 
                }
            }, [issues, aiKeys, aiCallWithKeys, dailyVerse, allKeysFailed]);

            const handleUnlock = async (code) => {
                setVerifying(true); setUnlockError("");
                const res = await checkCodeOnline(code, targetIssueId);
                if(res.success) {
                    const newUnlocked = [...unlockedIssues, targetIssueId];
                    setUnlockedIssues(newUnlocked);
                    localStorage.setItem('bejouri_unlocked_list', JSON.stringify(newUnlocked));
                    setActiveIssue(issues.find(i => i.id === targetIssueId));
                    setShowUnlock(false);
                    setView("issue");
                    setAppAlert("ØªÙ… ÙØªØ­ Ø§Ù„Ø¹Ø¯Ø¯ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                } else {
                    setUnlockError(res.error === "USED" ? t.errUsed : res.error === "WRONG_ISSUE" ? t.errWrong : res.error === "INVALID" ? t.errInvalid : t.errNetwork);
                }
                setVerifying(false);
            };

            if(view === "issue" && activeIssue) return <IssueDetail issue={activeIssue} onBack={()=>setView("home")} t={t} setAlert={setAppAlert} aiCall={aiCallWithKeys} />;

            return (
                <div className="min-h-screen relative text-gray-900 dark:text-white font-sans transition-colors duration-300">
                    {showIntro && <IntroModal onClose={() => setShowIntro(false)} data={introData} t={t} />}
                    <div className="app-bg" style={{ backgroundImage: appBg || 'none', backgroundColor: appBg ? 'transparent' : '#f8fafc' }}></div>
                    
                    <div className="sticky top-0 z-10 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md p-4 shadow-sm flex justify-between items-center rounded-b-2xl mx-2 mt-2">
                        <div className="flex items-center gap-4">
                            {appLogo && <img src={appLogo} alt="Logo" className="h-20 w-20 object-contain drop-shadow-md" />}
                            <div>
                                <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 drop-shadow-sm tracking-tight">{t.appTitle}</h1>
                                <p className="text-sm font-bold text-gray-500 dark:text-gray-400 mt-1">{t.subTitle}</p>
                            </div>
                        </div>
                        <div className="flex gap-2 items-center">
                            <button onClick={()=>setLang(prev => prev === 'ar' ? 'en' : 'ar')} className="bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-lg font-bold text-xs shadow-md">{t.langBtn}</button>
                            <button onClick={()=>setTheme(prev => prev === 'light' ? 'dark' : 'light')} className="w-10 h-10 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center shadow text-xl">{theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
                        </div>
                    </div>

                    <div className="p-4 space-y-4 pb-20 relative z-0">
                        {/* Daily Verse Section */}
                        {issues.length > 0 && dailyVerse && dailyVerse.text && (
                            <div className="animate-fade-in my-8">
                                <div className="flex items-start gap-3 relative">
                                    <div className="w-12 h-12 bg-indigo-500 rounded-full flex items-center justify-center text-2xl shadow-md border-2 border-indigo-100 text-white z-10">âœï¸</div>
                                    <div className="flex-1 verse-bubble p-4 shadow-xl">
                                        <h4 className="text-xs font-bold text-indigo-600 dark:text-indigo-400 mb-1">{t.verseTitle}</h4>
                                        <p className="text-lg font-bold leading-relaxed">{dailyVerse.text}</p>
                                        <div className="text-right text-xs text-gray-500 mt-2 font-bold">â€” {dailyVerse.ref}</div>
                                        <button onClick={()=>handleReflectionClick(dailyVerse.text)} disabled={reflecting} className="mt-3 text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-700 px-3 py-1 rounded-full font-bold">{reflecting ? "Ø¬Ø§Ø±ÙŠ..." : t.reflectBtn}</button>
                                    </div>
                                </div>
                                {reflection && <div className="mt-4 mr-10 bg-yellow-50 dark:bg-gray-800 p-4 rounded-xl border-r-4 border-yellow-400 shadow-md animate-pop-in"><div className="flex justify-between items-center mb-2"><h5 className="font-bold text-xs text-yellow-600">{t.reflectTitle}</h5><button onClick={()=>{setReflection(""); localStorage.removeItem('bejouri_reflection_cache');}}>âœ•</button></div><p className="text-sm leading-relaxed whitespace-pre-wrap">{reflection}</p></div>}
                            </div>
                        )}
                        
                        {/* Riddles Leaderboard is REMOVED from the main flow */}

                        {issues.map(issue => {
                            const isOpen = issue.is_free || unlockedIssues.includes(issue.id) || unlockedIssues.includes(String(issue.id));
                            return (
                                <div key={issue.id} onClick={() => isOpen ? (setActiveIssue(issue), setView("issue")) : (setTargetIssueId(issue.id), setShowUnlock(true), setUnlockError(""))} className="relative overflow-hidden bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 transform transition hover:-translate-y-1 cursor-pointer group">
                                    <div className="flex h-36">
                                        <div className="w-32 shrink-0 relative overflow-hidden">{issue.background ? <img src={issue.background} className="w-full h-full object-cover transition duration-500 group-hover:scale-110" alt="Cover" /> : <div className="w-full h-full flex items-center justify-center text-5xl bg-indigo-50 text-indigo-300">ğŸ“–</div>}</div>
                                        <div className="flex-1 p-5 flex flex-col justify-center bg-gradient-to-l from-gray-50 to-white dark:from-gray-800 dark:to-gray-900">
                                            <div className="flex items-center justify-between mb-2"><span className="text-xs font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900 dark:text-indigo-300 px-2 py-1 rounded-md">{issue.date?.ar}</span>{isOpen && <span className={`text-xs px-2 py-1 rounded-full font-bold ${issue.is_free ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}>{issue.is_free ? t.free : t.open}</span>}</div>
                                            <h3 className="text-2xl font-black text-gray-800 dark:text-white leading-tight mb-1">{issue.title.ar}</h3>
                                            <p className="text-xs text-gray-400 font-bold">Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙØ­</p>
                                        </div>
                                    </div>
                                    {!isOpen && <div className="absolute inset-0 bg-white/30 dark:bg-black/50 backdrop-blur-[1px] flex flex-col items-center justify-center z-10"><div className="bg-white/90 dark:bg-gray-900/90 p-3 rounded-full shadow-xl animate-bounce"><span className="text-2xl">ğŸ”’</span></div></div>}
                                </div>
                            );
                        })}
                    </div>

                    {/* Floating Friends Button (Right) */}
                    <button onClick={() => setShowFriendsForm(true)} className="fixed bottom-4 right-4 z-40 bg-gradient-to-r from-pink-500 to-rose-500 text-white px-6 py-4 rounded-full font-black text-lg shadow-2xl hover:scale-110 transition transform flex items-center gap-2 border-4 border-white animate-bounce-slow">
                        <span>ğŸ¤</span> {t.joinFriends}
                    </button>
                    
                    {/* Floating Riddle Heroes Button (Left) - NEW */}
                    <button onClick={() => setShowRiddlesHeroes(true)} className="fixed bottom-4 left-4 z-40 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-4 rounded-full font-black text-lg shadow-2xl hover:scale-110 transition transform flex items-center gap-2 border-4 border-white animate-bounce-slow">
                        <span>ğŸ¥‡</span> {t.riddleHeroes}
                    </button>


                    {showFriendsForm && <FriendsModal t={t} onClose={() => setShowFriendsForm(false)} setAlert={setAppAlert} />}
                    {showRiddlesHeroes && <RiddleHeroesModal t={t} onClose={() => setShowRiddlesHeroes(false)} riddleUser={riddleUser} />}
                    
                    {showUnlock && <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"><div className="bg-white dark:bg-gray-900 w-full max-w-md p-6 rounded-3xl relative animate-pop-in shadow-2xl"><button onClick={()=>{setShowUnlock(false); if(window.stopScan) window.stopScan();}} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-xl">âœ•</button><UnlockView onUnlock={handleUnlock} t={t} error={unlockError} processing={verifying} /></div></div>}
                    
                    {alertMessage && <MessageModal message={alertMessage} onClose={() => setAlertMessage(null)} type={alertType} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>