<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BeØ¬ÙˆØ±ÙŠ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4338ca">
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- âœ… Ù…ÙƒØªØ¨Ø© Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Cairo'], en: ['Fredoka'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)', 'pulsered': 'pulsered 1.5s infinite' },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, 
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        float: { '0%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-10px)' }, '100%': { transform: 'translateY(0px)' } },
                        pulsered: { '0%, 100%': { backgroundColor: 'rgba(239, 68, 68, 1)' }, '50%': { backgroundColor: 'rgba(239, 68, 68, 0.5)' } } 
                    } 
                } 
            } 
        }
    </script>
    <style>
        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø¯Ø§ÙƒÙ†Ø© */
        body { background-color: #f8fafc; font-family: 'Cairo', sans-serif; transition: background-color 0.3s; }
        .dark body { background-color: #0f172a; color: #e2e8f0; }
        
        /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ - Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ */
        .app-bg { position: fixed; inset: 0; z-index: -1; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; }
        
        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ */
        .locked-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .verse-bubble { background-color: #fff; border-radius: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 2px solid #6366f1; animation: float 5s ease-in-out infinite; }
        .dark .verse-bubble { background-color: #1e293b; border-color: #4f46e5; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); }
        .chat-bubble-user { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; border-radius: 20px 20px 5px 20px; }
        .chat-bubble-ai { background: #ffffff; border-radius: 20px 20px 20px 5px; }
        .dark .chat-bubble-ai { background: #1e293b; color: #e2e8f0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // âœ… Ø¨ÙŠØ§Ù†Ø§Øª Supabase ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
        const SUPABASE_URL = "https://ozdnyepxfcjzldpkteau.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96ZG55ZXB4ZmNqemxkcGt0ZWF1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NDEwNTM3MiwiZXhwIjoyMDc5NjgxMzcyfQ.mtqFcdRZeidpC0Ul8r_8FJOJalToT4lZeHNqd3-fsOg";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // âš ï¸ Ù…ÙØªØ§Ø­ Gemini API - Ù„Ù… ÙŠØ¹Ø¯ ÙŠÙØ³ØªØ®Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ø³ÙŠØªÙ… Ø¥Ø¯Ø§Ø±ØªÙ‡ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù…ØµÙÙˆÙØ© ÙÙŠ Supabase
        // **Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…ØŒ Ù„Ù† ÙŠØ¹Ù…Ù„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.**

        const TRANSLATIONS = {
            ar: {
                appTitle: "BeØ¬ÙˆØ±ÙŠ", subTitle: "Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ÙƒÙ†ÙŠØ³Ø©", loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
                free: "Ù…Ø¬Ø§Ù†ÙŠ ğŸ", locked: "Ø§Ø¶ØºØ· Ù„Ù„ÙØªØ­", open: "Ù…ÙØªÙˆØ­ âœ…",
                loginTitle: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„", scanBtn: "ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§", manualBtn: "Ø§ÙƒØªØ¨ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø¯Ø¯", activateBtn: "ÙØªØ­ Ø§Ù„Ø¹Ø¯Ø¯ ğŸš€",
                errUsed: "Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„! ğŸš«", errWrong: "Ù…ÙØªØ§Ø­ Ù„Ø¹Ø¯Ø¯ Ø¢Ø®Ø±! âš ï¸", errInvalid: "Ù…ÙØªØ§Ø­ Ø®Ø§Ø·Ø¦! âŒ",
                verseTitle: "Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø¡ ğŸ•Šï¸", langBtn: "English",
                introTitle: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ø¬ÙˆØ±ÙŠ! ğŸ‘‹", introBody: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ BeØ¬ÙˆØ±ÙŠ.", introBtn: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš€",
                score: "Ø§Ù„Ù†ØªÙŠØ¬Ø©", playAgain: "Ø§Ù„Ø¹Ø¨ ØªØ§Ù†ÙŠ ğŸ”„",
                qSource: "Ù…ØµØ¯Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:", qSrcInside: "Ù…Ù† Ù‚Ù„Ø¨ Ø§Ù„Ù…Ø¬Ù„Ø© ğŸ“–", qSrcOutside: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© ğŸŒ",
                qType: "Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:", qTypeRel: "Ø¯ÙŠÙ†ÙŠ âœï¸", qTypeSci: "Ø¹Ù„Ù…ÙŠ ğŸ”¬",
                storyTab: "âœ¨ Ù‚ØµØµ", storySetup: "Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­ÙƒØ§ÙŠØ§Øª", storyPrompt: "Ø¹Ù† Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø§Ù„Ù‚ØµØ©ØŸ", storyGen: "Ø§Ø­ÙƒÙŠ Ù„ÙŠ ğŸ“–", storyVirtue: "ÙØ¶ÙŠÙ„Ø©", storySaint: "Ù‚Ø¯ÙŠØ³",
                reflectBtn: "âœ¨ ØªØ£Ù…Ù„", reflectTitle: "ØªØ£Ù…Ù„ ÙÙŠ Ø§Ù„Ø¢ÙŠØ©",
                activitiesTab: "âœ¨ Ø£Ù†Ø´Ø·Ø©", actRiddle: "ğŸ§  ÙÙˆØ§Ø²ÙŠØ±", actPrayer: "ğŸ™ ØµÙ„Ø§ØªÙŠ",
                riddleGen: "ÙØ²ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ²", riddlePlaceholder: "Ù…ÙŠÙ† Ù‡ÙˆØŸ", riddleCheck: "ØªØ®Ù…ÙŠÙ† âœ…", riddleWrong: "Ø­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ âŒ", riddleCorrect: "ØµØ­! ğŸ‰",
                prayerTitle: "Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ", prayerGen: "Ø§ÙƒØªØ¨ Ù„ÙŠ ØµÙ„Ø§Ø© âœ¨", prayerTopic: "Ù…Ø«Ø§Ù„: Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§ØªØŒ ØµØ¯ÙŠÙ‚ÙŠ Ø§Ù„Ù…Ø±ÙŠØ¶...",
                friendsBook: "Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ø¬ÙŠØ¨ ğŸ“–",
                regTitle: "ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬ÙˆØ±ÙŠ ğŸŒ¹", regName: "Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø«Ù„Ø§Ø«ÙŠ)", regPhone: "Ø±Ù‚Ù… ØªÙ„ÙŠÙÙˆÙ†Ùƒ", regParent: "Ø±Ù‚Ù… Ø¨Ø§Ø¨Ø§ Ø£Ùˆ Ù…Ø§Ù…Ø§", regGrade: "Ø£Ù†Øª ÙÙŠ Ø³Ù†Ø© ÙƒØ§Ù…ØŸ", regBtn: "Ø³Ø¬Ù„ ÙˆØ§Ø¯Ø®Ù„ ÙŠØ§ Ø¬ÙˆØ±ÙŠ ğŸš€",
                apiError: "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.",
                dataError: "Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.",
                keysFailed: "ØªÙ… Ø§Ø³ØªÙ†ÙØ§Ø° Ø¬Ù…ÙŠØ¹ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ! âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯)."
            },
            en: {
                appTitle: "BeJouri", subTitle: "Church Heroes", loading: "Loading...",
                free: "Free ğŸ", locked: "Tap to Unlock", open: "Open âœ…",
                loginTitle: "Heroes Gate", scanBtn: "ğŸ“· Scan QR", manualBtn: "Enter Key", activateBtn: "Unlock Issue ğŸš€",
                errUsed: "Key Used! ğŸš«", errWrong: "Wrong Issue! âš ï¸", errInvalid: "Invalid Key! âŒ",
                verseTitle: "Message from Heaven ğŸ•Šï¸", langBtn: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
                introTitle: "Welcome Jouri! ğŸ‘‹", introBody: "Welcome to BeJouri app.", introBtn: "Start Journey ğŸš€",
                score: "Score", playAgain: "Play Again ğŸ”„",
                qSource: "Source:", qSrcInside: "Inside Magazine ğŸ“–", qSrcOutside: "General Knowledge ğŸŒ",
                qType: "Type:", qTypeRel: "Religious âœï¸", qTypeSci: "Scientific ğŸ”¬",
                storyTab: "âœ¨ Stories", storySetup: "Tales Library", storyPrompt: "What is the story about?", storyGen: "Tell me ğŸ“–", storyVirtue: "Virtue", storySaint: "Saint",
                reflectBtn: "âœ¨ Reflect", reflectTitle: "Verse Reflection",
                activitiesTab: "âœ¨ Activities", actRiddle: "ğŸ§  Riddles", actPrayer: "ğŸ™ Prayers",
                riddleGen: "New Riddle ğŸ²", riddlePlaceholder: "Who is it?", riddleCheck: "Guess âœ…", riddleCorrect: "Correct! ğŸ‰", riddleWrong: "Try Again âŒ",
                prayerTitle: "Your Request", prayerGen: "Compose Prayer âœ¨", prayerTopic: "e.g., Exams, Sick friend...",
                friendsBook: "Wonder Book ğŸ“–",
                regTitle: "Jouri Registration ğŸŒ¹", regName: "Full Name", regPhone: "Your Phone", regParent: "Parent Phone", regGrade: "Grade", regBtn: "Register & Enter ğŸš€",
                apiError: "AI connection error.",
                dataError: "Data registration error.",
                keysFailed: "All AI keys are exhausted! âš ï¸ Please update them in the Dashboard."
            }
        };

        function getYoutubeEmbed(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) return `https://www.youtube.com/embed/${match[2]}`;
            return null;
        }

        async function checkCodeOnline(code, issueId) {
            try {
                const cleanCode = code.trim().toUpperCase();
                if(cleanCode === "ADMIN123") return { success: true };
                const { data, error } = await supabase.from('codes').select('*').eq('code', cleanCode).single();
                if (error || !data) return { success: false, error: "INVALID" };
                if (String(data.issue_id) !== String(issueId)) return { success: false, error: "WRONG_ISSUE" };
                if (data.used) return { success: false, error: "USED" };
                await supabase.from('codes').update({ used: true, used_at: new Date() }).eq('code', cleanCode);
                return { success: true };
            } catch (e) { return { success: false, error: "NET_ERROR" }; }
        }

        // âš ï¸ Ø¯Ø§Ù„Ø© callGemini Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        // ØªØªÙ„Ù‚Ù‰ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ù…ÙƒÙˆÙ† App Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Ù†
        const callGemini = async (prompt, aiKeys, activeKeyIndex, setActiveKeyIndex, setAiKeys, setAllKeysFailed) => {
            let keys = [...aiKeys];
            let startingIndex = activeKeyIndex;
            let currentIndex = startingIndex;
            const maxAttempts = keys.length || 1;

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØ§ØªÙŠØ­ Ø¨Ø¹Ø¯ØŒ Ù†ÙØ´Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ±
            if (keys.length === 0) {
                 throw new Error("API_KEY_MISSING");
            }
            
            // Outer loop for rotation attempts (max one full cycle)
            for (let attempts = 0; attempts < maxAttempts; attempts++) {
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ§Ù„ÙŠ ØºÙŠØ± Ø§Ù„ÙØ§Ø´Ù„ (Ø¨Ø¯Ø¡Ù‹Ø§ Ù…Ù† currentIndex)
                let keyFound = false;
                let nextIndex = currentIndex;
                for (let i = 0; i < keys.length; i++) {
                    const checkIndex = (currentIndex + i) % keys.length;
                    const keyObj = keys[checkIndex];
                    if (keyObj.status !== 'failed' && keyObj.status !== 'network_failed' && !(keyObj.expires && new Date(keyObj.expires) < new Date())) {
                        nextIndex = checkIndex;
                        keyFound = true;
                        break;
                    }
                }
                
                if (!keyFound) {
                    // Ù„Ù… Ù†Ø¬Ø¯ Ø£ÙŠ Ù…ÙØªØ§Ø­ ØµØ§Ù„Ø­ ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    break; 
                }

                currentIndex = nextIndex;
                const currentKeyObj = keys[currentIndex];
                const apiKey = currentKeyObj?.key;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(url, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) 
                    });

                    if (response.ok) {
                        // Ø§Ù„Ù†Ø¬Ø§Ø­: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ø´Ø· ÙˆØ§Ù„Ø­Ø§Ù„Ø©
                        setActiveKeyIndex(currentIndex);
                        setAllKeysFailed(false); 
                        return (await response.json()).candidates?.[0]?.content?.parts?.[0]?.text || "No response";
                    }
                    
                    // ÙØ´Ù„ API (Ù…Ø«Ù„ 400, 429, 500)
                    console.warn(`API Call failed for key at index ${currentIndex} with status ${response.status}. Rotating key.`);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ÙØ§Ø´Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹
                    currentKeyObj.status = 'failed'; 
                    setAiKeys([...keys]);
                    
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ§Ù„ÙŠ
                    currentIndex = (currentIndex + 1) % keys.length;
                    setActiveKeyIndex(currentIndex);

                    await new Promise(resolve => setTimeout(resolve, 500)); 

                } catch (e) {
                    // ÙØ´Ù„ Ø´Ø¨ÙƒØ© (CORS, Offline, Ø¥Ù„Ø®)
                    console.error(`Network error for key ${currentIndex}:`, e);
                    
                    currentKeyObj.status = 'network_failed'; 
                    setAiKeys([...keys]);
                    
                    currentIndex = (currentIndex + 1) % keys.length;
                    setActiveKeyIndex(currentIndex);

                    await new Promise(resolve => setTimeout(resolve, 500)); 
                }

                 // Ø¥Ø°Ø§ Ø¹Ø¯Ù†Ø§ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŒ Ù†ØªÙˆÙ‚Ù
                if (currentIndex === startingIndex) {
                     break;
                }
            }
            
            // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø­Ù„Ù‚Ø© Ø¯ÙˆÙ† Ù†Ø¬Ø§Ø­ØŒ Ù†ÙØ´Ù„ ÙƒÙ„ÙŠØ§Ù‹
            setAllKeysFailed(true);
            throw new Error("ALL_KEYS_FAILED");
        };

        function MessageModal({ message, onClose, type = 'error' }) {
            let icon, color;
            switch(type) {
                case 'success': icon = 'ğŸ‰'; color = 'bg-green-100 text-green-800 border-green-500'; break;
                case 'warning': icon = 'âš ï¸'; color = 'bg-yellow-100 text-yellow-800 border-yellow-500'; break;
                default: icon = 'âŒ'; color = 'bg-red-100 text-red-800 border-red-500'; break;
            }

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-fade-in">
                    <div className={`bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-xs text-center shadow-2xl border-4 ${color} relative overflow-hidden animate-pop-in`}>
                        <div className="text-4xl mb-4">{icon}</div>
                        <p className="text-lg font-bold text-gray-800 dark:text-gray-200 mb-6 leading-relaxed">{message}</p>
                        <button onClick={onClose} className="w-full bg-indigo-600 text-white py-2 rounded-xl font-bold text-lg shadow-lg hover:scale-[1.02] transition transform">Ø­Ø³Ù†Ø§Ù‹</button>
                    </div>
                </div>
            );
        }

        function IntroModal({ onClose, data, t }) {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-fade-in">
                    <div className="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-sm text-center shadow-2xl border-4 border-indigo-500 relative overflow-hidden animate-pop-in">
                        <div className="text-6xl mb-6 animate-bounce">ğŸ‘‹â¤ï¸</div>
                        <h2 className="text-2xl font-black text-indigo-800 dark:text-white mb-4">{data.title || t.introTitle}</h2>
                        <p className="text-lg text-gray-600 dark:text-gray-300 mb-8 leading-relaxed">{data.body || t.introBody}</p>
                        <button onClick={onClose} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-black text-xl shadow-lg hover:scale-105 transition transform">{t.introBtn}</button>
                    </div>
                </div>
            );
        }

        // âœ… Ù…ÙƒÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ (Ø¨Ø§Ø³Ù… Ø¬ÙˆØ±ÙŠ)
        function RegistrationModal({ t, onRegister, setAlert }) {
            const [data, setData] = React.useState({ name: '', phone: '', parent: '', grade: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ' });
            const [loading, setLoading] = React.useState(false);

            const handleSubmit = async () => {
                if (!data.name || !data.phone || !data.parent) return setAlert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ§ Ø¬ÙˆØ±ÙŠ!");
                setLoading(true);
                try {
                    const { data: child, error } = await supabase.from('children').insert([{ 
                        full_name: data.name, phone: data.phone, parent_phone: data.parent, grade: data.grade, points: 10 
                    }]).select().single();
                    
                    if (error) throw error;
                    
                    localStorage.setItem('bejouri_child_id', JSON.stringify(child));
                    onRegister(child);
                    setAlert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¬ÙˆØ±ÙŠ.", 'success');

                } catch (e) { setAlert(t.dataError); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-indigo-900/95 backdrop-blur-xl animate-fade-in">
                    <div className="bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl relative animate-pop-in border-4 border-yellow-400">
                        <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 text-6xl">ğŸ“</div>
                        <h2 className="text-2xl font-black text-center text-indigo-800 mb-6 mt-4">{t.regTitle}</h2>
                        <div className="space-y-4">
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">{t.regName}</label><input value={data.name} onChange={e=>setData({...data, name: e.target.value})} className="w-full p-3 bg-gray-50 border-2 rounded-xl font-bold text-indigo-900 focus:border-indigo-500 outline-none"/></div>
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">{t.regPhone}</label><input type="tel" value={data.phone} onChange={e=>setData({...data, phone: e.target.value})} className="w-full p-3 bg-gray-50 border-2 rounded-xl font-bold text-indigo-900 focus:border-indigo-500 outline-none"/></div>
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">{t.regParent}</label><input type="tel" value={data.parent} onChange={e=>setData({...data, parent: e.target.value})} className="w-full p-3 bg-gray-50 border-2 rounded-xl font-bold text-indigo-900 focus:border-indigo-500 outline-none"/></div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">{t.regGrade}</label>
                                <select value={data.grade} onChange={e=>setData({...data, grade: e.target.value})} className="w-full p-3 bg-gray-50 border-2 rounded-xl font-bold text-indigo-900 focus:border-indigo-500 outline-none">
                                    <option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                </select>
                            </div>
                            <button onClick={handleSubmit} disabled={loading} className="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-4 rounded-xl font-black text-xl shadow-lg hover:scale-105 transition transform mt-2">
                                {loading ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„..." : t.regBtn}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function StoryView({ t, setAlert, aiCall }) { // âœ… ØªØ­Ø¯ÙŠØ«: Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ aiCall
            const [topic, setTopic] = React.useState("");
            const [story, setStory] = React.useState("");
            const [loading, setLoading] = React.useState(false);
            const generateStory = async () => {
                if(!topic) return setAlert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ ÙÙƒØ±Ø© Ø§Ù„Ù‚ØµØ© Ø£ÙˆÙ„Ø§Ù‹!");
                setLoading(true);
                try { 
                    const text = await aiCall(`Write a short story for Christian children in Egyptian Arabic about: "${topic}".`); // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… aiCall
                    setStory(text); 
                } catch(e) { 
                    if (e.message.includes("API_KEY_MISSING") || e.message.includes("ALL_KEYS_FAILED")) setAlert(t.keysFailed, 'warning'); // âœ… Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                    else setAlert(t.apiError); 
                } 
                setLoading(false);
            };
            return (
                <div className="h-full flex flex-col p-6 bg-indigo-50 dark:bg-gray-900 overflow-y-auto">
                    {!story ? (
                        <div className="flex flex-col items-center justify-center h-full text-center">
                            <div className="text-6xl mb-4">ğŸ“š</div><h2 className="text-2xl font-bold mb-6 dark:text-white">{t.storySetup}</h2>
                            <input value={topic} onChange={e=>setTopic(e.target.value)} placeholder={t.storyPrompt} className="w-full max-w-sm p-4 rounded-xl shadow-sm border-2 border-indigo-100 mb-4 text-center text-lg" />
                            <button onClick={generateStory} disabled={loading} className="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg hover:bg-indigo-700 transition">{loading ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙƒÙŠ..." : t.storyGen}</button>
                        </div>
                    ) : (
                        <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl relative">
                            <button onClick={()=>setStory("")} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 font-bold">âœ•</button>
                            <div className="prose dark:prose-invert text-lg leading-loose text-gray-700 dark:text-gray-200 whitespace-pre-wrap font-medium">{story}</div>
                        </div>
                    )}
                </div>
            );
        }

        function ActivitiesView({ t, setAlert, aiCall }) { // âœ… ØªØ­Ø¯ÙŠØ«: Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ aiCall
            const [mode, setMode] = React.useState('menu'); 
            const [data, setData] = React.useState(null); 
            const [input, setInput] = React.useState(""); 
            const [feedback, setFeedback] = React.useState(""); 
            const [loading, setLoading] = React.useState(false);

            const generateRiddle = async () => {
                setLoading(true); 
                setFeedback(""); 
                setInput("");
                try { 
                    const rawText = await aiCall(`Generate a riddle in Arabic about a Coptic Saint. Return ONLY the JSON object: { "riddle": "...", "answer": "..." }. Ensure the answer is the saint's name only.`); // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… aiCall
                    const cleanText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const json = JSON.parse(cleanText); 
                    setData(json); 
                } catch(e) { 
                    console.error(e);
                    if (e.message.includes("API_KEY_MISSING") || e.message.includes("ALL_KEYS_FAILED")) setAlert(t.keysFailed, 'warning'); // âœ… Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                    else setAlert(t.apiError); 
                    setMode('menu'); 
                } 
                setLoading(false);
            };

            const checkRiddle = async () => {
                if(!input || !data) return; 
                setLoading(true);
                try { 
                    const rawText = await aiCall(`Answer: "${data.answer}". Guess: "${input}". Are they the same person? Return ONLY the JSON object: { "correct": true/false }. Be lenient with minor spelling differences.`); // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… aiCall
                    const cleanText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const json = JSON.parse(cleanText); 
                    setFeedback(json.correct ? "correct" : "wrong"); 
                } catch(e) { 
                    setFeedback("wrong"); 
                    if (e.message.includes("API_KEY_MISSING") || e.message.includes("ALL_KEYS_FAILED")) setAlert(t.keysFailed, 'warning'); // âœ… Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                    else setAlert(t.apiError); 
                } 
                setLoading(false);
            };

            const generatePrayer = async () => {
                if(!input) return setAlert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹!");
                setLoading(true); 
                try { 
                    const text = await aiCall(`Write a short Coptic prayer in formal Arabic about the topic: "${input}".`); // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… aiCall
                    setData(text); 
                } catch(e) { 
                    if (e.message.includes("API_KEY_MISSING") || e.message.includes("ALL_KEYS_FAILED")) setAlert(t.keysFailed, 'warning'); // âœ… Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                    else setAlert(t.apiError); 
                } 
                setLoading(false);
            };

            if(mode === 'menu') return (<div className="h-full flex flex-col items-center justify-center p-6 gap-4"><button onClick={()=>{setMode('riddle'); generateRiddle();}} className="w-full max-w-xs p-6 bg-purple-500 rounded-2xl text-white font-black text-xl shadow-lg hover:bg-purple-600 transition">{t.actRiddle}</button><button onClick={()=>{setMode('prayer'); setData(null); setInput("");}} className="w-full max-w-xs p-6 bg-emerald-500 rounded-2xl text-white font-black text-xl shadow-lg hover:bg-emerald-600 transition">{t.actPrayer}</button></div>);
            
            if(mode === 'riddle') return (
                <div className="h-full flex flex-col p-6 text-center overflow-y-auto bg-gray-50 dark:bg-gray-900">
                    <button onClick={()=>setMode('menu')} className="self-start mb-4 text-indigo-600 dark:text-indigo-400 font-bold">
                        <span className="transform rotate-180 inline-block">âœ</span> Ø§Ù„Ø¹ÙˆØ¯Ø©
                    </button>
                    {loading && !data ? (<div className="flex flex-col items-center justify-center h-full"><span className="text-4xl animate-bounce">ğŸ²</span><p className="mt-4 text-gray-500 dark:text-gray-300">{t.loading}</p></div>) : (
                        <div className="flex flex-col items-center">
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl mb-4 w-full border-2 border-purple-200 dark:border-purple-800">
                                <p className="text-lg font-bold text-gray-800 dark:text-white">{data?.riddle}</p>
                            </div>
                            {feedback !== 'correct' && (<div className="flex gap-2 w-full max-w-md"><input value={input} onChange={e=>setInput(e.target.value)} placeholder={t.riddlePlaceholder} className="flex-1 p-3 border-2 rounded-xl text-center focus:border-purple-500 outline-none dark:bg-gray-700 dark:text-white" /><button onClick={checkRiddle} disabled={loading} className="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:bg-purple-700 transition">
                                {loading ? "..." : t.riddleCheck}
                            </button></div>)}
                            {feedback === 'correct' && <div className="mt-4 bg-green-100 p-4 rounded-xl w-full max-w-md text-green-800 font-black animate-pop-in border-2 border-green-500">{t.riddleCorrect}</div>}
                            {feedback === 'wrong' && <div className="mt-4 bg-red-100 p-4 rounded-xl w-full max-w-md text-red-800 font-bold animate-fade-in border-2 border-red-500">{t.riddleWrong}</div>}
                            <button onClick={generateRiddle} disabled={loading} className="mt-6 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-6 py-2 rounded-full font-bold shadow hover:bg-purple-200 transition">
                                {loading ? t.loading : t.riddleGen}
                            </button>
                        </div>
                    )}
                </div>
            );
            
            if(mode === 'prayer') return (
                <div className="h-full flex flex-col p-6 text-center overflow-y-auto bg-gray-50 dark:bg-gray-900">
                    <button onClick={()=>setMode('menu')} className="self-start mb-4 text-emerald-600 dark:text-emerald-400 font-bold">
                        <span className="transform rotate-180 inline-block">âœ</span> Ø§Ù„Ø¹ÙˆØ¯Ø©
                    </button>
                    {!data ? (
                        <div className="flex flex-col items-center justify-center h-full">
                            <div className="text-6xl mb-6">ğŸ™</div>
                            <input value={input} onChange={e=>setInput(e.target.value)} placeholder={t.prayerTopic} className="w-full max-w-md p-4 border-2 border-emerald-300 rounded-xl mb-6 text-center focus:border-emerald-500 outline-none dark:bg-gray-700 dark:text-white"/>
                            <button onClick={generatePrayer} disabled={loading} className="bg-emerald-600 text-white px-8 py-3 rounded-xl font-black text-xl shadow-lg hover:bg-emerald-700 transition">
                                {loading ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©..." : t.prayerGen}
                            </button>
                        </div>
                    ) : (
                        <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl relative border-t-4 border-emerald-500 animate-pop-in">
                            <button onClick={()=>setData(null)} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-xl">âœ•</button>
                            <h3 className="text-lg font-bold text-emerald-600 mb-4">{t.prayerTitle}</h3>
                            <p className="text-base leading-relaxed whitespace-pre-wrap text-gray-700 dark:text-gray-300">{data}</p>
                        </div>
                    )}
                </div>
            );
        }

        function IssueDetail({ issue, onBack, t, setAlert, aiCall }) { // âœ… ØªØ­Ø¯ÙŠØ«: Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ aiCall
            const [tab, setTab] = React.useState("mag");
            const [child, setChild] = React.useContext(ChildContext);

            return (
                <div className="h-screen flex flex-col bg-white dark:bg-gray-900">
                    <div className="flex items-center justify-between p-3 border-b dark:border-gray-800 shadow-sm z-20">
                        <button onClick={onBack} className="w-10 h-10 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center font-bold text-indigo-600 dark:text-indigo-400 transform rotate-180 shadow hover:bg-gray-200 transition">âœ</button>
                        <div className="text-sm font-black truncate px-2 dark:text-white">{issue.title.ar}</div>
                        <div className="w-10"></div>
                    </div>
                    <div className="flex justify-around bg-indigo-50 dark:bg-gray-800 p-1">
                        <button onClick={()=>setTab('mag')} className={`flex-1 py-2 text-xs font-bold rounded-lg ${tab==='mag'?'bg-white dark:bg-gray-900 text-indigo-600 shadow':'text-gray-500 dark:text-gray-400'}`}>ğŸ“– Ø§Ù„Ù…Ø¬Ù„Ø©</button>
                        <button onClick={()=>setTab('video')} className={`flex-1 py-2 text-xs font-bold rounded-lg ${tab==='video'?'bg-white dark:bg-gray-900 text-indigo-600 shadow':'text-gray-500 dark:text-gray-400'}`}>ğŸ“º ÙÙŠØ¯ÙŠÙˆ</button>
                        <button onClick={()=>setTab('story')} className={`flex-1 py-2 text-xs font-bold rounded-lg ${tab==='story'?'bg-white dark:bg-gray-900 text-indigo-600 shadow':'text-gray-500 dark:text-gray-400'}`}>{t.storyTab}</button>
                        <button onClick={()=>setTab('activities')} className={`flex-1 py-2 text-xs font-bold rounded-lg ${tab==='activities'?'bg-white dark:bg-gray-900 text-indigo-600 shadow':'text-gray-500 dark:text-gray-400'}`}>{t.activitiesTab}</button>
                    </div>
                    <div className="flex-1 bg-gray-100 dark:bg-black relative overflow-hidden">
                        
                        {/* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù„Ø© */}
                        {tab === 'mag' && <iframe src={issue.magazine_url} className="w-full h-full border-none bg-white"></iframe>}
                        {/* Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª */}
                        {tab === 'video' && <div className="h-full overflow-y-auto p-4 space-y-4">{issue.videos && issue.videos.map((v, i) => (<div key={i} className="bg-white dark:bg-gray-800 p-2 rounded-xl shadow"><div className="aspect-video bg-black"><iframe src={getYoutubeEmbed(v.url)} className="w-full h-full"></iframe></div></div>))}</div>}
                        {/* Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµØµ */}
                        {tab === 'story' && <StoryView t={t} setAlert={setAlert} aiCall={aiCall} />}
                        {/* Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù†Ø´Ø·Ø© */}
                        {tab === 'activities' && <ActivitiesView t={t} setAlert={setAlert} aiCall={aiCall} />}
                    </div>
                </div>
            );
        }

        function LoginView({ onLogin, error, processing, t, setAlert }) {
            const [code, setCode] = React.useState("");
            const [scanning, setScanning] = React.useState(false);
            const startScan = () => { 
                setScanning(true); 
                setTimeout(() => { 
                    const scanner = new Html5Qrcode("reader"); 
                    scanner.start({ facingMode: "environment" }, { fps: 10 }, 
                        (decoded) => { 
                            scanner.stop(); 
                            setScanning(false); 
                            onLogin(decoded); 
                        }, 
                        (errMsg) => {
                            if (errMsg.includes("No user")) {
                                // Ignore camera not found errors which are common in safe environments
                            } else {
                                console.error("QR Error:", errMsg);
                            }
                        }); 
                }, 100); 
            };

            return (
                <div className="flex flex-col items-center text-center">
                    <h2 className="text-2xl font-black mb-4 dark:text-white">{t.loginTitle}</h2>
                    {scanning ? <div id="reader" className="w-full h-64 bg-black mb-4 rounded-xl"></div> : <button onClick={startScan} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-black text-lg mb-4 shadow-lg hover:bg-indigo-700 transition">{t.scanBtn}</button>}
                    <input value={code} onChange={e=>setCode(e.target.value.toUpperCase())} placeholder={t.manualBtn} className="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700 dark:text-white text-center font-bold mb-3 border-2 focus:border-yellow-400 outline-none" />
                    <button onClick={()=>onLogin(code)} disabled={processing} className="w-full py-3 bg-yellow-400 font-black text-lg rounded-xl shadow-lg hover:bg-yellow-500 transition">
                        {processing ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚..." : t.activateBtn}
                    </button>
                    {error && <div className="mt-4 p-2 bg-red-100 text-red-700 font-bold rounded-lg border border-red-300 w-full">{error}</div>}
                </div>
            );
        }

        const ChildContext = React.createContext();

        function App() {
            const [view, setView] = React.useState("home");
            const [lang, setLang] = React.useState(localStorage.getItem('bejouri_lang') || 'ar');
            const [theme, setTheme] = React.useState(localStorage.getItem('bejouri_theme') || 'light');
            const [issues, setIssues] = React.useState([]);
            const [unlocked, setUnlocked] = React.useState(JSON.parse(localStorage.getItem('bejouri_unlocked') || '[]'));
            const [activeIssue, setActiveIssue] = React.useState(null);
            const [showLogin, setShowLogin] = React.useState(false);
            const [targetId, setTargetId] = React.useState(null);
            const [loginError, setLoginError] = React.useState("");
            const [verifying, setVerifying] = React.useState(false);
            
            // âœ… Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø´Ø¹Ø§Ø±
            const [appBg, setAppBg] = React.useState('');
            const [appLogo, setAppLogo] = React.useState('');
            
            const [introData, setIntroData] = React.useState({}); 
            const [showIntro, setShowIntro] = React.useState(true); 
            const [showFriends, setShowFriends] = React.useState(false); 
            
            // âœ… Ø­Ø§Ù„Ø© Ø§Ù„Ø¢ÙŠØ© ÙˆØ§Ù„ØªØ£Ù…Ù„
            const [reflection, setReflection] = React.useState("");
            const [reflecting, setReflecting] = React.useState(false);
            
            // âœ… Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·ÙÙ„ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„
            const [child, setChild] = React.useState(JSON.parse(localStorage.getItem('bejouri_child_id')));
            const [isLoginEnabled, setIsLoginEnabled] = React.useState(false);
            const [alertMessage, setAlertMessage] = React.useState(null);
            const [alertType, setAlertType] = React.useState('error');

            // ğŸ’¡ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ§Ù„Ø¯ÙˆØ±Ø§Ù† (Key Pool Management)
            const [aiKeys, setAiKeys] = React.useState([]);
            const [activeKeyIndex, setActiveKeyIndex] = React.useState(0);
            const [allKeysFailed, setAllKeysFailed] = React.useState(false);
            
            const setAppAlert = (message, type = 'error') => {
                setAlertMessage(message);
                setAlertType(type);
            }

            // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ£Ù…Ù„ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù† ÙˆØ¸ÙŠÙØ© aiCall Ø§Ù„ØªÙŠ ØªØ¯ÙŠØ± Ø§Ù„Ù…ÙØ§ØªÙŠØ­
            const handleReflection = React.useCallback(async (verse, aiCall) => { 
                setReflecting(true); 
                setReflection("");
                try { 
                    const text = await aiCall(`Write a short Coptic contemplation/reflection for a child in Arabic based on the Bible verse: "${verse}"`); 
                    setReflection(text); 
                } catch(e) { 
                    if (e.message.includes("API_KEY_MISSING") || e.message.includes("ALL_KEYS_FAILED")) setAppAlert(TRANSLATIONS[lang].keysFailed, 'warning');
                    else setAppAlert(TRANSLATIONS[lang].apiError); 
                } 
                setReflecting(false); 
            }, [lang]);

            const t = TRANSLATIONS[lang];

            React.useEffect(() => {
                if (theme === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
                localStorage.setItem('bejouri_theme', theme);
                document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                localStorage.setItem('bejouri_lang', lang);

                const fetchData = async () => {
                    // Fetch Settings
                    try {
                        const { data: settings } = await supabase.from('settings').select('value').eq('key', 'config').single();
                        if (settings) {
                            // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø´Ø¹Ø§Ø± ÙˆÙ…ØµÙÙˆÙØ© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                            if (settings.value.appBackground) setAppBg(`url("${settings.value.appBackground}")`);
                            if (settings.value.appLogo) setAppLogo(settings.value.appLogo);
                            if (settings.value.enableChildLogin) setIsLoginEnabled(true); 
                            setIntroData({ title: settings.value.introTitle, body: settings.value.introBody });
                            
                            // ğŸ’¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙˆØªØ¬Ù‡ÙŠØ²Ù‡Ø§ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
                            if (settings.value.gemini_keys_list && Array.isArray(settings.value.gemini_keys_list)) {
                                // Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ø­Ø§Ù„Ø© (status) Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ ÙˆØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ù„Ù€ 'unused'
                                const initialKeys = settings.value.gemini_keys_list.map(k => ({...k, status: k.status || 'unused'}));
                                setAiKeys(initialKeys);
                            } else {
                                setAiKeys([]); // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ§ØªÙŠØ­
                            }
                        }
                    } catch(e) { console.error("Failed to fetch settings:", e); }

                    // Fetch Issues
                    try {
                        const { data: issuesData } = await supabase.from('issues').select('*').order('created_at', { ascending: false });
                        if (issuesData) setIssues(issuesData);
                    } catch(e) { console.error("Failed to fetch issues:", e); }
                };
                fetchData();
            }, [lang, theme]);


            // ğŸ’¡ ÙˆØ¸ÙŠÙØ© aiCall ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ÙØ­Ù…Ù„Ø© Ù…Ù† Supabase
            const aiCallWithKeys = React.useCallback(async (prompt) => {
                return callGemini(prompt, aiKeys, activeKeyIndex, setActiveKeyIndex, setAiKeys, setAllKeysFailed);
            }, [aiKeys, activeKeyIndex, setAiKeys, setActiveKeyIndex, setAllKeysFailed]);


            // âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø¨Ø¶Ø§Øª (10 Ø¯Ù‚Ø§Ø¦Ù‚) - Ù…Ø¹Ø¯Ù„ Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø·ÙÙ„ Ø§Ù„Ù…Ø³Ø¬Ù„
            React.useEffect(() => {
                const sendHeartbeat = async () => {
                    let userId = child ? `child_${child.id}` : localStorage.getItem('bejouri_user_id');
                    if (!userId && !child) {
                        userId = 'user_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('bejouri_user_id', userId);
                    }
                    try {
                        await supabase.from('online_users').upsert({ user_id: userId, last_seen: new Date() }, { onConflict: 'user_id' });
                    } catch(e) { console.error("Heartbeat failed:", e); }
                };
                sendHeartbeat();
                const interval = setInterval(sendHeartbeat, 600000); 
                return () => clearInterval(interval);
            }, [child]);

            const handleUnlock = async (code) => {
                setVerifying(true); setLoginError("");
                const res = await checkCodeOnline(code, targetId);
                if(res.success) {
                    const newUnlocked = [...unlocked, targetId];
                    setUnlocked(newUnlocked);
                    localStorage.setItem('bejouri_unlocked', JSON.stringify(newUnlocked));
                    setActiveIssue(issues.find(i => i.id === targetId));
                    setShowLogin(false); setView("issue");
                    
                    // âœ… Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ù„Ù„Ø·ÙÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø¹Ø¯Ø¯ Ø¬Ø¯ÙŠØ¯
                    if (child) {
                        try {
                            const { data: updated, error } = await supabase.from('children').update({ points: child.points + 50 }).eq('id', child.id).select().single();
                            if (error) throw error;
                            if (updated) { 
                                setChild(updated); 
                                localStorage.setItem('bejouri_child_id', JSON.stringify(updated)); 
                                setAppAlert("Ù…Ø¨Ø±ÙˆÙƒ! Ø£Ø®Ø°Øª 50 Ù†Ù‚Ø·Ø© ğŸ‰", 'success');
                            }
                        } catch(e) {
                            console.error("Failed to update points:", e);
                            setAppAlert("ØªÙ… ÙØªØ­ Ø§Ù„Ø¹Ø¯Ø¯ Ø¨Ù†Ø¬Ø§Ø­ ÙˆÙ„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·.", 'warning');
                        }
                    } else {
                        setAppAlert("ØªÙ… ÙØªØ­ Ø§Ù„Ø¹Ø¯Ø¯ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                    }
                } else {
                    if(res.error === "USED") setLoginError(t.errUsed); 
                    else if(res.error === "WRONG_ISSUE") setLoginError(t.errWrong); 
                    else if(res.error === "INVALID") setLoginError(t.errInvalid); 
                    else setLoginError("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©.");
                }
                setVerifying(false);
            };

            const toggleTheme = () => setTheme(prev => prev === 'light' ? 'dark' : 'light');
            const toggleLang = () => setLang(prev => prev === 'ar' ? 'en' : 'ar');
            
            // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ÙŠØ²Ø© Ù…ÙØ¹Ù„Ø© ÙˆØ§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…Ø³Ø¬Ù„
            if (isLoginEnabled && !child) {
                return <RegistrationModal t={t} onRegister={setChild} setAlert={setAppAlert} />;
            }

            if(view === "issue" && activeIssue) return (
                <ChildContext.Provider value={[child, setChild]}>
                    <IssueDetail 
                        issue={activeIssue} 
                        onBack={()=>setView("home")} 
                        t={t} 
                        setAlert={setAppAlert} 
                        aiCall={aiCallWithKeys} // âœ… ØªÙ…Ø±ÙŠØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§ØªØµØ§Ù„
                    />
                    {alertMessage && <MessageModal message={alertMessage} onClose={() => setAlertMessage(null)} type={alertType} />}
                </ChildContext.Provider>
            );

            return (
                <div className="min-h-screen relative text-gray-900 dark:text-white font-sans transition-colors duration-300">
                    {showIntro && <IntroModal onClose={() => setShowIntro(false)} data={introData} t={t} />}
                    
                    {/* Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ - ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ± appBg Ø§Ù„Ø°ÙŠ ÙŠØªÙ… Ø³Ø­Ø¨Ù‡ Ù…Ù† Supabase */}
                    <div className="app-bg" style={{ backgroundImage: appBg || 'none', backgroundColor: appBg ? 'transparent' : '#f8fafc' }}></div>
                    
                    <div className="sticky top-0 z-10 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md p-4 shadow-sm flex justify-between items-center rounded-b-2xl mx-2 mt-2">
                        <div className="flex items-center gap-4">
                            {appLogo && <img src={appLogo} alt="Logo" className="h-20 w-20 object-contain drop-shadow-md" />}
                            <div>
                                {/* âœ… Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ ÙˆÙ†Ù‚Ø§Ø·Ù‡ */}
                                {child ? (
                                    <div className="flex flex-col">
                                        <span className="text-lg font-black text-indigo-700 dark:text-indigo-300">Ø£Ù‡Ù„Ø§Ù‹ØŒ {child.full_name.split(' ')[0]} ğŸ‘‹</span>
                                        <span className="text-xs font-bold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full w-fit shadow-md">â­ {child.points} Ù†Ù‚Ø·Ø©</span>
                                    </div>
                                ) : (
                                    <>
                                        <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 drop-shadow-sm tracking-tight">{t.appTitle}</h1>
                                        <p className="text-sm font-bold text-gray-500 dark:text-gray-400 mt-1">{t.subTitle}</p>
                                    </>
                                )}
                            </div>
                        </div>
                        <div className="flex gap-2 items-center">
                            {/* ğŸ’¡ Ø±Ø³Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ */}
                            {allKeysFailed && (
                                <div className="animate-pulsered rounded-full px-2 py-1 text-xs font-bold text-white shadow-lg">âš ï¸ Key Error</div>
                            )}
                            
                            {/* âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø¬ÙˆØ§Ù„ */}
                            <button onClick={() => setShowFriends(true)} className="bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 px-3 py-1 rounded-lg font-bold text-xs transition hover:scale-105 flex items-center gap-1 shadow-md">
                                <span className="text-base">ğŸ“–</span>
                                {/* Ø§Ù„Ù†Øµ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (sm) */}
                                <span className="hidden sm:inline">{t.friendsBook}</span>
                            </button>
                            
                            <button onClick={toggleLang} className="bg-gray-100 dark:bg-gray-800 dark:text-white px-3 py-1 rounded-lg font-bold text-xs transition hover:scale-105 shadow-md">{t.langBtn}</button>
                            <button onClick={toggleTheme} className="w-10 h-10 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center shadow transition hover:scale-105 text-xl">{theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™'}</button>
                        </div>
                    </div>

                    <div className="p-4 space-y-4 pb-20 relative z-0">
                        {issues.length > 0 && issues[0].verse && issues[0].verse.text && (
                            <div className="animate-fade-in my-8">
                                <div className="flex items-start gap-3 relative">
                                    <div className="w-12 h-12 bg-indigo-500 rounded-full flex items-center justify-center text-2xl shadow-md border-2 border-indigo-100 text-white z-10">âœï¸</div>
                                    <div className="flex-1 verse-bubble p-4 shadow-xl">
                                        <h4 className="text-xs font-bold text-indigo-600 dark:text-indigo-400 mb-1">{t.verseTitle}</h4>
                                        <p className="text-sm font-bold leading-relaxed text-gray-800 dark:text-gray-200">"{issues[0].verse.text}"</p>
                                        <div className="text-right text-xs text-gray-500 dark:text-gray-400 mt-2 font-bold">â€” {issues[0].verse.ref}</div>
                                        <button onClick={()=>handleReflection(issues[0].verse.text, aiCallWithKeys)} className="mt-3 text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-full font-bold hover:bg-indigo-200 transition flex items-center gap-1">
                                            {reflecting ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ£Ù…Ù„..." : t.reflectBtn}
                                        </button>
                                    </div>
                                </div>
                                {reflection && (<div className="mt-4 mr-10 bg-yellow-50 dark:bg-gray-800 p-4 rounded-xl border-r-4 border-yellow-400 shadow-md animate-pop-in"><div className="flex justify-between items-center mb-2"><h5 className="font-bold text-xs text-yellow-600 dark:text-yellow-400">{t.reflectTitle}</h5><button onClick={()=>setReflection("")} className="text-gray-400 hover:text-red-500">âœ•</button></div><p className="text-sm leading-relaxed text-gray-700 dark:text-gray-300 whitespace-pre-wrap">{reflection}</p></div>)}
                            </div>
                        )}

                        {issues.length === 0 && <div className="text-center bg-white/80 dark:bg-gray-800 p-8 rounded-2xl font-bold">{t.loading}</div>}
                        
                        {issues.map(issue => {
                            const isOpen = unlocked.includes(issue.id) || issue.is_free;
                            return (
                                <div key={issue.id} onClick={() => isOpen ? (setActiveIssue(issue), setView("issue")) : (setTargetId(issue.id), setShowLogin(true), setLoginError(""))} className="relative overflow-hidden bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 transform transition hover:-translate-y-1 cursor-pointer group">
                                    <div className="flex h-36">
                                        <div className="w-32 shrink-0 relative overflow-hidden">{issue.background ? (<img src={issue.background} className="w-full h-full object-cover transition duration-500 group-hover:scale-110" alt="Cover" />) : (<div className="w-full h-full flex items-center justify-center text-5xl bg-indigo-50 text-indigo-300">ğŸ“–</div>)}</div>
                                        <div className="flex-1 p-5 flex flex-col justify-center bg-gradient-to-l from-gray-50 to-white dark:from-gray-800 dark:to-gray-900">
                                            <div className="flex items-center justify-between mb-2"><span className="text-xs font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900 dark:text-indigo-300 px-2 py-1 rounded-md">{issue.date?.ar}</span>{isOpen && <span className={`text-xs px-2 py-1 rounded-full font-bold ${issue.is_free ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}>{issue.is_free ? t.free : t.open}</span>}</div>
                                            <h3 className="text-2xl font-black text-gray-800 dark:text-white leading-tight mb-1">{issue.title.ar}</h3>
                                            <p className="text-xs text-gray-400 font-bold">Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙØ­</p>
                                        </div>
                                    </div>
                                    {!isOpen && <div className="absolute inset-0 bg-white/30 dark:bg-black/50 backdrop-blur-[1px] flex flex-col items-center justify-center z-10"><div className="bg-white/90 dark:bg-gray-900/90 p-3 rounded-full shadow-xl animate-bounce"><span className="text-2xl">ğŸ”’</span></div></div>}
                                </div>
                            );
                        })}
                    </div>

                    {showFriends && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in"><div className="bg-white dark:bg-gray-900 w-full max-w-2xl max-h-[80vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col relative border border-white/20 animate-pop-in"><div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 flex justify-between items-center text-white"><div><h2 className="text-2xl font-black">Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø¹Ø¬ÙŠØ¨ ğŸ“–</h2><p className="text-sm text-indigo-100 font-medium">Ø­ÙƒØ§ÙŠØ§Øª ÙˆÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø£ØµØ­Ø§Ø¨Ù†Ø§</p></div><button onClick={() => setShowFriends(false)} className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30 transition text-lg font-bold">âœ•</button></div><div className="p-6 overflow-y-auto flex-1 bg-indigo-50 dark:bg-gray-800"><div className="text-center py-10 space-y-4"><div className="text-6xl animate-pulse">ğŸ“º</div><h3 className="text-xl font-bold text-gray-700 dark:text-gray-300">Ù‚Ø±ÙŠØ¨Ø§Ù‹.. ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø£Ø¨Ø·Ø§Ù„Ù†Ø§!</h3><p className="text-sm text-gray-500 dark:text-gray-400 max-w-xs mx-auto">Ù‡Ù†Ø§ Ù‡ØªÙ„Ø§Ù‚ÙŠ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙˆÙ…Ø´Ø§Ø±ÙƒØ§Øª Ø£ØµØ­Ø§Ø¨Ù†Ø§ Ø§Ù„Ø­Ù„ÙˆÙŠÙ†. Ø§Ø³ØªÙ†ÙˆÙ†Ø§!</p></div></div></div></div>)}
                    {showLogin && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"><div className="bg-white dark:bg-gray-900 w-full max-w-md p-6 rounded-3xl relative animate-pop-in shadow-2xl"><button onClick={()=>setShowLogin(false)} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-xl">âœ•</button><LoginView onLogin={handleUnlock} error={loginError} processing={verifying} t={t} setAlert={setAppAlert} /></div></div>)}
                    
                    {/* Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */}
                    {alertMessage && <MessageModal message={alertMessage} onClose={() => setAlertMessage(null)} type={alertType} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>